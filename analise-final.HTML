<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Final - Análise PE</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- VARIÁVEIS (Padrão Unificado) --- */
        :root {
            --azul-gov-principal: #002776;
            --azul-gov-escuro: #001a4d;
            --azul-gov-claro: #0052CC;
            --amarelo-gov-detalhe: #FFD700;
            --cinza-texto: #2c3e50;
            --cinza-claro: #7f8c8d;
            --cinza-fundo: #f8f9fa;
            --cinza-card: #ecf0f1;
            --branco: #ffffff;
            --verde-sucesso: #27ae60;
            --vermelho-destaque: #dc3545;
            --laranja-alerta: #fd7e14;
            --roxo-recurso: #6f42c1;
            --sombra-suave: 0 2px 8px rgba(0, 0, 0, 0.08);
            --sombra-media: 0 4px 16px rgba(0, 0, 0, 0.12);
            --transicao-padrao: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Segoe UI', -apple-system, Arial, sans-serif; 
            background-color: var(--cinza-fundo); 
            color: var(--cinza-texto); 
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER UNIFICADO --- */
        .main-header { 
            background-color: var(--branco); 
            box-shadow: var(--sombra-suave);
            padding: 0 5%; 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 3px solid var(--azul-gov-principal);
        }
        
        .main-nav { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 80px; 
        }

        .logo a { 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: var(--transicao-padrao);
        }

        .logo a:hover { transform: translateY(-2px); }

        .logo a > img { 
            height: 55px; 
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: var(--transicao-padrao);
        }

        .SIMPE-marca-text-group { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .SIMPE-marca-small { height: 55px !important; width: auto; object-fit: contain; }

        #nav-links { 
            list-style: none; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            gap: 8px; 
            align-items: center;
        }

        #nav-links a { 
            text-decoration: none; 
            color: var(--cinza-texto); 
            font-weight: 600; 
            padding: 12px 20px; 
            border-radius: 8px; 
            transition: var(--transicao-padrao); 
            position: relative;
        }

        #nav-links a::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 20px;
            right: 20px;
            height: 2px;
            background-color: var(--amarelo-gov-detalhe);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        #nav-links a:hover,
        #nav-links a.active { 
            color: var(--azul-gov-principal); 
            background-color: rgba(0, 39, 118, 0.05); 
        }

        #nav-links a:hover::after,
        #nav-links a.active::after {
            transform: scaleX(1);
        }

        /* --- MAIN --- */
        main { padding: 40px 5%; flex-grow: 1; display: flex; justify-content: center; }
        
        .report-container { 
            width: 100%;
            max-width: 1000px; 
        }

        /* --- CABEÇALHO DO RELATÓRIO --- */
        .report-header { 
            background: var(--branco); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: var(--sombra-suave); 
            margin-bottom: 30px; 
            border-left: 5px solid var(--azul-gov-principal);
        }
        
        .report-header h1 { 
            margin: 0 0 15px 0; 
            color: var(--azul-gov-principal); 
            font-size: 1.8em; 
            font-weight: 700; 
        }
        
        .report-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            font-size: 0.95em; 
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        /* --- PLACAR DE 4 NOTAS --- */
        .score-container-quatro-notas {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .score-box-quatro {
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-claro) 100%);
            color: var(--branco);
            padding: 20px;
            border-radius: 12px;
            transition: var(--transicao-padrao);
            box-shadow: var(--sombra-media);
            position: relative;
            overflow: hidden;
        }

        .score-box-quatro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--amarelo-gov-detalhe) 0%, transparent 100%);
        }

        .score-box-quatro:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-media);
        }

        .score-box-quatro h2 {
            margin: 0 0 5px 0;
            text-transform: uppercase;
            font-size: 0.85em;
            font-weight: 600;
            opacity: 0.9;
        }

        .score-box-quatro .score-value {
            font-size: 2em;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .score-box-quatro .score-descricao {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* --- CARDS DE RESPOSTA --- */
        .resposta-card { 
            background-color: var(--branco); 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: var(--sombra-suave); 
            overflow: hidden; 
            transition: var(--transicao-padrao);
            cursor: pointer;
        }
        
        .resposta-card:hover { box-shadow: var(--sombra-media); }

        .card-mantido-sim { border-left: 5px solid var(--verde-sucesso); }
        .card-mantido-nao { border-left: 5px solid var(--vermelho-destaque); }
        .card-alterado-rejeitado { border-left: 5px solid var(--amarelo-gov-detalhe); }
        .card-alterado-aprovado { border-left: 5px solid var(--azul-gov-principal); }
        .card-com-recurso-indicador { border-right: 5px solid var(--roxo-recurso); }

        .resposta-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: #fcfcfc;
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        .resposta-header strong { 
            flex-grow: 1; 
            color: var(--azul-gov-principal); 
            font-size: 1.05em; 
        }
        
        .resposta-body { padding: 20px; }

        .summary-header { 
            cursor: pointer; 
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-header strong { 
            font-weight: 700; 
            flex: 1;
        }

        .summary-status-container { 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- BADGES --- */
        .atende-badge, 
        .summary-status-badge,
        .status-validacao,
        .recurso-badge { 
            font-weight: 700; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            display: inline-block;
            white-space: nowrap;
            box-shadow: var(--sombra-suave);
        }

        .atende-badge { color: var(--branco); }
        .atende-badge { 
            color: white !important; 
        }
        .atende-sim, .status-aprovado, .summary-status-mantido, .summary-status-atende { background-color: var(--verde-sucesso); }
        .atende-nao, .status-rejeitado, .summary-status-nao-atende { background-color: var(--vermelho-destaque); }
        .status-pendente, .summary-status-pendente { background-color: #ffc107; color: #333; }
        .summary-status-recurso { background-color: var(--roxo-recurso); }
        .summary-status-alterado-aprovado { background-color: var(--azul-gov-principal); }
        .summary-status-alterado-rejeitado { background-color: var(--amarelo-gov-detalhe); color: #333; }

        .recurso-badge {
            background-color: var(--roxo-recurso);
            color: var(--branco);
            font-size: 0.7em;
            text-transform: uppercase;
        }

        /* --- TABELA DE SUBITENS (se precisar) --- */
        .subitens-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .subitens-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .subitens-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .subitem-validacao {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            width: 100%;
        }

        /* --- EVIDÊNCIAS E COMENTÁRIOS --- */
        .evidence-section, .comment-section { 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 1px solid #f0f0f0; 
        }
        
        .evidence-list { list-style: none; padding-left: 0; }
        
        .evidence-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: #f8f9fa; 
            padding: 10px 14px; 
            border-radius: 6px; 
            margin-bottom: 6px; 
            border: 1px solid #e1e5e9;
        }
        
        .evidence-item a { color: var(--azul-gov-claro); text-decoration: none; word-break: break-all; }
        .evidence-item a:hover { text-decoration: underline; }

        .admin-comment, .analise-final-comment { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 0.95em; 
            min-height: 80px; 
            resize: none; 
            margin-bottom: 15px;
            font-family: inherit;
        }

        .admin-comment:focus { border-color: var(--azul-gov-principal); outline: none; }

        /* --- BOTÕES --- */
        .btn { 
            padding: 12px 24px; 
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-claro) 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: var(--transicao-padrao); 
            box-shadow: var(--sombra-suave);
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--sombra-media); 
        }

        .btn-toggle { 
            padding: 8px 16px; 
            border: 2px solid #e1e5e9; 
            background-color: var(--branco); 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transicao-padrao);
            min-width: 100px;
            text-align: center;
        }
        
        .btn-toggle:hover { background-color: #f8f9fa; }

        .btn-toggle.active { 
            background-color: var(--verde-sucesso); 
            color: var(--branco); 
            border-color: var(--verde-sucesso); 
        }
        
        .btn-toggle[data-action*="nao"].active { 
            background-color: var(--vermelho-destaque); 
            border-color: var(--vermelho-destaque); 
        }

        .btn-add-evidence { 
            padding: 8px 16px; 
            border: 1px dashed var(--azul-gov-principal); 
            background-color: rgba(0, 39, 118, 0.05); 
            color: var(--azul-gov-principal); 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-add-evidence:hover { 
            background-color: rgba(0, 39, 118, 0.1); 
            border-style: solid;
        }

        .remove-evidence-btn {
            background: var(--vermelho-destaque); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .remove-evidence-btn:hover { background: #c0392b; }

        /* --- SEÇÕES DE VALIDAÇÃO --- */
        .validation-section { 
            margin-top: 20px; 
            padding: 20px; 
            border-top: 2px dashed #e1e5e9; 
        }

        .validation-actions { 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            gap: 10px; 
            margin-top: 15px;
        }

        .analise-scge-destaque,
        .analise-final-destaque,
        .admin-feedback-box { 
            padding: 20px; 
            border-radius: 8px; 
            margin: 15px 0; 
        }

        .analise-scge-destaque { 
            background: #e9eef5; 
            border: 2px solid var(--azul-gov-principal); 
        }

        .analise-final-destaque { 
            background: #e8f5e8; 
            border: 2px solid var(--verde-sucesso); 
        }

        .analise-final-destaque.rejeitado { 
            background: #fde8e8; 
            border-color: var(--vermelho-destaque); 
        }

        .admin-feedback-box { 
            background: #e9eef5; 
            border-left: 4px solid var(--azul-gov-principal); 
        }

        /* --- MODAL --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
        }

        .modal-content { 
            background: var(--branco); 
            padding: 30px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative; 
            border-top: 5px solid var(--azul-gov-principal);
        }

        .modal-close-btn { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            background: none; 
            border: none; 
            font-size: 2.5em; 
            color: #aaa; 
            cursor: pointer; 
            transition: color 0.3s;
        }

        .modal-close-btn:hover { color: var(--vermelho-destaque); }

        .info-block { 
            border-top: 1px solid #eee; 
            padding-top: 20px; 
            margin-top: 20px; 
        }

        .info-block:first-child { 
            border-top: none; 
            padding-top: 0; 
            margin-top: 0; 
        }

        .info-block h4, .info-block h5 { 
            margin: 0 0 10px 0; 
            color: var(--azul-gov-principal); 
        }

        /* --- FOOTER --- */
        .main-footer { 
            text-align: center; 
            padding: 30px 5%; 
            margin-top: auto;
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-escuro) 100%);
            color: var(--branco);
            position: relative; 
            min-height: 80px;
        }

        .main-footer .footer-content { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            max-width: 1400px;
            margin: 0 auto;
            height: 100%; 
            position: relative;
        }

        .main-footer .footer-portal-link,
        .main-footer .footer-logo-link { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            height: 70px; 
            transition: transform 0.3s;
        }

        .main-footer .footer-portal-link { left: 0.5%; }
        .main-footer .footer-logo-link { right: 0.5%; }

        .main-footer img { 
            height: 100%; 
            filter: brightness(0) invert(1); 
        }

        .main-footer p a { 
            color: var(--amarelo-gov-detalhe); 
            text-decoration: none; 
            padding: 4px 8px; 
        }

        .main-footer p a:hover { 
            background-color: rgba(255, 215, 0, 0.2); 
            text-decoration: underline; 
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .main-nav { flex-direction: column; height: auto; padding: 20px 0; }
            .main-nav ul { flex-direction: column; width: 100%; margin-top: 15px; }
            .score-container-quatro-notas { grid-template-columns: 1fr; gap: 10px; }
            .report-header { padding: 20px; }
            .report-summary { grid-template-columns: 1fr; }
            
            .main-footer { padding: 20px; }
            .main-footer .footer-content { flex-direction: column; gap: 15px; }
            .main-footer .footer-portal-link,
            .main-footer .footer-logo-link { 
                position: static; 
                transform: none; 
                height: 50px; 
                margin: 10px 0; 
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="main-nav">
            <div class="logo">
                <a href="/">
                    <img src="/assets/logo-header.png" alt="Logo Governo de Pernambuco">
                    <div class="SIMPE-marca-text-group">                      
                        <img src="/assets/simpe.png" alt="Logo SIMPE" class="SIMPE-marca-small">                      
                    </div>
                </a>
            </div>
            <ul id="nav-links"></ul>
        </nav>
    </header>

    <main>
        <div class="report-container">
            <div id="summary-container" class="report-header"><p>Carregando dados...</p></div>

            <div id="score-container-quatro-notas" class="score-container-quatro-notas" style="display: none;">
                <div class="score-box-quatro">
                    <h2>Nota da Autoavaliação</h2>
                    <div id="score-autoavaliacao" class="score-value">-- / --</div>
                    <div class="score-descricao">Enviada pela secretaria</div>
                </div>
                <div class="score-box-quatro">
                    <h2>Nota da 1ª Validação</h2>
                    <div id="score-primeira-analise" class="score-value">-- / --</div>
                    <div class="score-descricao">Validada pela SCGE</div>
                </div>
                <div class="score-box-quatro">
                    <h2>Nota do Recurso</h2>
                    <div id="score-pos-recurso" class="score-value">-- / --</div>
                    <div class="score-descricao">Após análise dos recursos</div>
                </div>
                <div class="score-box-quatro">
                    <h2>Nota Final</h2>
                    <div id="score-final" class="score-value">-- / --</div>
                    <div class="score-descricao">Resultado definitivo</div>
                </div>
            </div>

            <div id="respostas-container"></div>
            <div id="actions-container" style="text-align: right; margin-top: 30px;"></div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <a href="https://transparencia.pe.gov.br/" target="_blank" rel="noopener noreferrer" class="footer-portal-link">
                <img src="/assets/image-portal.png" alt="Portal da Transparência">
            </a>

            <p>&copy; 2025 Governo de Pernambuco. Todos os direitos reservados. <a id="admin-footer-link" href="/admin" style="display: none;">Área Administrativa</a></p>
            
            <a href="https://www.scge.pe.gov.br/" target="_blank" rel="noopener noreferrer" class="footer-logo-link">
                <img src="/assets/logo-footer.png" alt="Logo da Controladoria-Geral do Estado de Pernambuco">
            </a>
        </div>
    </footer>

    <div id="modal-overlay" class="modal-overlay" style="display: none;" aria-hidden="true">
        <div id="modal-content" class="modal-content" tabindex="-1">
            <button id="modal-close-btn" class="modal-close-btn" aria-label="Fechar modal">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const avaliacaoId = window.location.pathname.split('/').pop();
            const summaryContainer = document.getElementById('summary-container');
            const scoreContainerQuatroNotas = document.getElementById('score-container-quatro-notas');
            const scoreAutoavaliacaoEl = document.getElementById('score-autoavaliacao');
            const scorePrimeiraAnaliseEl = document.getElementById('score-primeira-analise');
            const scorePosRecursoEl = document.getElementById('score-pos-recurso');
            const scoreFinalEl = document.getElementById('score-final');
            const respostasContainer = document.getElementById('respostas-container');
            const actionsContainer = document.getElementById('actions-container');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const navLinks = document.getElementById('nav-links');
            const logoutBtn = document.getElementById('logout-btn');
            const adminFooterLink = document.getElementById('admin-footer-link');
            const authToken = localStorage.getItem('authToken');

            let avaliacaoCompleta = null;
            let currentModalRespostaId = null;
            let isModalEditing = false;
            let modalHasChanges = false;

            function normalizarDadosResposta(resposta) {
                resposta.atendeOriginal = resposta.atendeOriginal !== undefined ? resposta.atendeOriginal : resposta.atende;
                return resposta;
            }

            function calcularPontuacaoPorFaixa(qtdAprovados, pontuacaoBase) {
                if (qtdAprovados >= 12) return pontuacaoBase;
                if (qtdAprovados >= 8) return pontuacaoBase * 0.7;
                if (qtdAprovados >= 4) return pontuacaoBase * 0.5;
                if (qtdAprovados >= 1) return pontuacaoBase * 0.3;
                return 0;
            }

            function calcularQuatroNotas() {
                if (!avaliacaoCompleta || !Array.isArray(avaliacaoCompleta.respostas)) {
                    return { autoavaliacao: 0, primeiraAnalise: 0, posRecurso: 0, final: 0, total: 0 };
                }

                let pontuacaoAutoavaliacao = 0;
                let pontuacaoPrimeiraAnalise = 0;
                let pontuacaoPosRecurso = 0;
                let pontuacaoFinal = 0;
                let pontuacaoTotal = 0;

                avaliacaoCompleta.respostas.forEach(resposta => {
                    const pontuacaoRequisito = resposta.requisito?.pontuacao || 0;
                    pontuacaoTotal += pontuacaoRequisito;

                    // Verificar se é requisito composto
                    if (resposta.subRespostas && resposta.subRespostas.length > 0) {
                        // Autoavaliação (baseado no que a secretaria marcou)
                        const aprovadosSecretaria = resposta.subRespostas.filter(s => s.atende === true).length;
                        pontuacaoAutoavaliacao += calcularPontuacaoPorFaixa(aprovadosSecretaria, pontuacaoRequisito);

                        // Primeira análise (statusValidacao)
                        const aprovadosPrimeira = resposta.subRespostas.filter(s => s.statusValidacao === 'aprovado').length;
                        pontuacaoPrimeiraAnalise += calcularPontuacaoPorFaixa(aprovadosPrimeira, pontuacaoRequisito);

                        // Pós-recurso (statusValidacaoPosRecurso)
                        const aprovadosRecurso = resposta.subRespostas.filter(s => s.statusValidacaoPosRecurso === 'aprovado').length;
                        pontuacaoPosRecurso += calcularPontuacaoPorFaixa(aprovadosRecurso, pontuacaoRequisito);

                        // Final (prioriza pós-recurso, senão primeira análise)
                        const aprovadosFinal = resposta.subRespostas.filter(s => 
                            (s.statusValidacaoPosRecurso || s.statusValidacao) === 'aprovado'
                        ).length;
                        pontuacaoFinal += calcularPontuacaoPorFaixa(aprovadosFinal, pontuacaoRequisito);
                    } else {
                        // Requisitos normais (código existente)
                        if (resposta.atendeOriginal === true) {
                            pontuacaoAutoavaliacao += pontuacaoRequisito;
                        }
                        if (resposta.statusValidacao === 'aprovado') {
                            pontuacaoPrimeiraAnalise += pontuacaoRequisito;
                        }
                        
                        const teveRecurso = resposta.recursoAtende !== null ||
                                        resposta.comentarioRecurso ||
                                        (resposta.evidencias?.some(e => e.tipo === 'recurso'));
                        
                        if (teveRecurso) {
                            if (resposta.recursoAtende === true) {
                                pontuacaoPosRecurso += pontuacaoRequisito;
                            }
                        } else {
                            if (resposta.statusValidacao === 'aprovado') {
                                pontuacaoPosRecurso += pontuacaoRequisito;
                            }
                        }

                        const statusFinal = resposta.analiseFinal?.statusValidacaoPosRecurso || resposta.statusValidacao;
                        if (statusFinal === 'aprovado') {
                            pontuacaoFinal += pontuacaoRequisito;
                        }
                    }
                });

                return {
                    autoavaliacao: parseFloat(pontuacaoAutoavaliacao.toFixed(1)),
                    primeiraAnalise: parseFloat(pontuacaoPrimeiraAnalise.toFixed(1)),
                    posRecurso: parseFloat(pontuacaoPosRecurso.toFixed(1)),
                    final: parseFloat(pontuacaoFinal.toFixed(1)),
                    total: pontuacaoTotal
                };
            }

            function exibirQuatroNotas() {
                const notas = calcularQuatroNotas();

                scoreAutoavaliacaoEl.textContent = `${notas.autoavaliacao} / ${notas.total}`;
                scorePrimeiraAnaliseEl.textContent = `${notas.primeiraAnalise} / ${notas.total}`;
                scorePosRecursoEl.textContent = `${notas.posRecurso} / ${notas.total}`;
                scoreFinalEl.textContent = `${notas.final} / ${notas.total}`;

                scoreContainerQuatroNotas.style.display = 'grid';
            }

            function construirInterfaceValidacaoModal(resposta) {
                const analiseFinal = resposta.analiseFinal || {};
                const statusFinalAtual = analiseFinal.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';

                return `
                    <div class="validation-section">
                        <h4>Análise Final (Pós-Recurso)</h4>

                        <div class="link-analista-container">
                            <h5>Links de Referência da Análise Final:</h5>
                            <div id="modal-links-analise-final-display" class="link-analista-display" style="margin-bottom: 8px;">
                                <span style="font-size: 0.85em; color: #6c757d;">Nenhum link adicionado.</span>
                            </div>
                            <button class="btn-add-evidence btn-add-link-analista-final" 
                                    style="background-color: var(--azul-gov-principal); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                + Adicionar Link
                            </button>
                        </div>
                        
                        <textarea id="modal-analise-final-comment" class="admin-comment" 
                                placeholder="Adicionar comentário específico para a análise final (não substitui o comentário anterior)...">${analiseFinal.comentario || ''}</textarea>
                    

                        <div class="validation-actions">
                            <span class="status-validacao status-${determinarStatusRecurso(resposta, statusFinalAtual)}">
                                ${determinarTextoStatusRecurso(resposta, statusFinalAtual)}
                            </span>
                            <button class="btn-toggle ${statusFinalAtual === 'rejeitado' ? 'active' : ''}"
                                    data-action="nao-atende-final" data-validation-type="normal">Não Atende</button>
                            <button class="btn-toggle ${statusFinalAtual === 'aprovado' ? 'active' : ''}"
                                    data-action="atende-final" data-validation-type="normal">Atende</button>
                        </div>
                        <div class="validation-actions" style="justify-content: space-between; margin-top: 15px;">
                            <button id="cancelar-edicao-btn" class="btn" style="background-color: #6c757d;">Cancelar</button>
                            <button id="salvar-analise-final-btn" class="btn">Salvar Análise Final</button>
                        </div>
                    </div>`;
            }


            function determinarTextoStatusRecurso(resposta, statusFinal) {
                if (!statusFinal || statusFinal === 'pendente') {
                    return 'Pendente';
                }

                const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                    resposta.comentarioRecurso ||
                                    (resposta.evidencias && resposta.evidencias.some(e => e.tipo === 'recurso'));

                if (!teveRecurso) {
                    return statusFinal === 'aprovado' ? 'Aprovado' : 'Rejeitado';
                }

                const respostaRecursoAtende = resposta.atende; 
                const analiseFinalAtende = statusFinal === 'aprovado';

                return respostaRecursoAtende === analiseFinalAtende ? 'Mantido' : 'Alterado';
            }

            function determinarStatusRecurso(resposta, statusFinal) {
                if (!statusFinal || statusFinal === 'pendente') {
                    return 'pendente';
                }

                return statusFinal === 'aprovado' ? 'aprovado' : 'rejeitado';

            }

            function configurarNavegacao() {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const adminFooterLink = document.getElementById('admin-footer-link');

                if (adminFooterLink) {
                    if (userData.role === 'ADMIN') {
                        adminFooterLink.style.display = 'inline';
                    } else {
                        adminFooterLink.style.display = 'none'; 
                    }
                }
            }

            if (!avaliacaoId) {
                summaryContainer.innerHTML = '<h1>Erro: ID da Avaliação não encontrado na URL.</h1>';
                return;
            }

            if (!authToken) {
                Swal.fire('Erro de Autenticação', 'Token de autenticação não encontrado. Faça login novamente.', 'error');
                window.location.href = '/login';
                return;
            }

            function recalcularEExibirPontuacoes() {
                exibirQuatroNotas();
            }

            // FUNÇÃO: Abrir modal com detalhes da resposta
            function abrirModal(resposta) {
                currentModalRespostaId = resposta.id;
                const analiseFinal = resposta.analiseFinal || {};
                const statusFinalConsiderado = analiseFinal.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';

                let originalAnswerHTML = `
                    <p><strong>Resposta:</strong>
                        <span class="atende-badge ${resposta.atendeOriginal ? 'atende-sim' : 'atende-nao'}">
                            ${resposta.atendeOriginal ? 'Atende' : 'Não Atende'}
                        </span>
                    </p>`;

                const evidenciasOriginais = Array.isArray(resposta.evidencias) ? resposta.evidencias.filter(e => e.tipo === 'original') : [];
                let originalEvidencesHTML = '';
                if (resposta.linkComprovante || evidenciasOriginais.length > 0) {
                    originalEvidencesHTML = `<div class="evidence-section"><h5>Evidências Originais:</h5><ul class="evidence-list">`;
                    if (resposta.linkComprovante) {
                        originalEvidencesHTML += `<li class="evidence-item"><a href="${resposta.linkComprovante}" target="_blank">${resposta.linkComprovante}</a> (Link Comprovante)</li>`;
                    }
                    evidenciasOriginais.forEach(ev => {
                        originalEvidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`;
                    });
                    originalEvidencesHTML += `</ul></div>`;
                }

                const statusPrimeiraAnalise = resposta.statusValidacao || 'pendente';
                const statusTextoPrimeiraAnalise = statusPrimeiraAnalise === 'pendente' ? 'Pendente' :
                    (resposta.atendeOriginal === (statusPrimeiraAnalise === 'aprovado') ? 'Mantido' : 'Alterado');
                const statusClassePrimeiraAnalise = statusPrimeiraAnalise === 'pendente' ? 'pendente' : (statusPrimeiraAnalise === 'aprovado' ? 'aprovado' : 'rejeitado');


                let primeiraAnaliseHTML = `
                    <div class="info-block analise-scge-destaque">
                        <h5>1ª Análise da SCGE</h5>
                        <p><strong>Resultado:</strong>
                            <span class="status-validacao status-${statusClassePrimeiraAnalise}">${statusTextoPrimeiraAnalise}</span>
                        </p>
                        ${resposta.linksAnalista && resposta.linksAnalista.length > 0 ? `
                            <div class="link-analista-container">
                                <h5>Links de Referência da 1ª Análise</h5>
                                <div class="link-analista-display">
                                    ${resposta.linksAnalista.map(link => `
                                        <div class="evidence-item">
                                            <a href="${link.url}" target="_blank" title="Abrir link em nova aba">${link.url}</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${resposta.comentarioAdmin ? `
                            <div class="comentario-analista-destaque">
                                <strong>Comentário da 1ª análise:</strong>
                                <p>"${resposta.comentarioAdmin}"</p>
                            </div>
                        ` : '<p><em>Nenhum comentário na 1ª análise.</em></p>'}
                    </div>`;

                let recursoHTML = '';
                const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                    resposta.comentarioRecurso ||
                                    (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));


                if (teveRecurso) {
                    let recursoAnswerHTML = `
                        <p><strong>Nova Resposta (Recurso):</strong>
                            <span class="atende-badge ${resposta.atende ? 'atende-sim' : 'atende-nao'}">
                                ${resposta.atende ? 'Atende' : 'Não Atende'}
                            </span>
                        </p>`;

                    const evidenciasRecurso = Array.isArray(resposta.evidencias) ? resposta.evidencias.filter(e => e.tipo === 'recurso') : [];
                    let recursoEvidencesHTML = '';
                    if (evidenciasRecurso.length > 0 || resposta.linkComprovanteRecurso) {
                        recursoEvidencesHTML = `<div class="evidence-section"><h5>Evidências do Recurso:</h5><ul class="evidence-list">`;
                        if (resposta.linkComprovanteRecurso) {
                            recursoEvidencesHTML += `<li class="evidence-item"><a href="${resposta.linkComprovanteRecurso}" target="_blank">${resposta.linkComprovanteRecurso}</a> (Comprovante Recurso)</li>`;
                        }
                        evidenciasRecurso.forEach(ev => {
                            recursoEvidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`;
                        });
                        recursoEvidencesHTML += `</ul></div>`;
                    }

                    recursoHTML = `
                        <div class="info-block">
                            <h5>Recurso Submetido pela Secretaria</h5>
                            ${recursoAnswerHTML}
                            ${resposta.comentarioRecurso ? `<p><strong>Justificativa do Recurso:</strong> "${resposta.comentarioRecurso}"</p>` : ''}
                            ${recursoEvidencesHTML}
                        </div>`;
                }

                let analiseFinalHTML = '';
                    const temAnaliseFinalRealizada = analiseFinal.statusValidacaoPosRecurso && analiseFinal.statusValidacaoPosRecurso !== 'pendente';

                    if (temAnaliseFinalRealizada) {
                        const resultadoFinalTexto = determinarTextoStatusRecurso(resposta, analiseFinal.statusValidacaoPosRecurso); 
                        const resultadoFinalClasseCor = determinarStatusRecurso(resposta, analiseFinal.statusValidacaoPosRecurso); 
                        const aprovadoOuRejeitadoTexto = analiseFinal.statusValidacaoPosRecurso === 'aprovado' ? 'Aprovado' : 'Rejeitado'; 

                        let linksAnaliseFinalHTML = '';
                        if (resposta.linksAnaliseFinal && resposta.linksAnaliseFinal.length > 0) {
                            linksAnaliseFinalHTML = `
                                <div class="links-analista-section">
                                    <h5>Links de Referência da Análise Final</h5>
                                    <div class="links-analista-compact">
                                        <ul class="evidence-list">
                                            ${resposta.linksAnaliseFinal.map(link => `
                                                <li class="evidence-item">
                                                    <a href="${link.url}" target="_blank" title="Abrir link em nova aba">${link.url}</a>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>`;
                        }

                        analiseFinalHTML = `
                            <div class="analise-final-destaque ${resultadoFinalClasseCor === 'rejeitado' ? 'rejeitado' : ''}">
                                <h5>Análise Final da SCGE (Pós-Recurso)</h5>
                                <p><strong>Resultado:</strong>
                                    <span class="status-validacao status-${resultadoFinalClasseCor}">
                                        ${resultadoFinalTexto} (${aprovadoOuRejeitadoTexto})
                                    </span>
                                </p>
                                ${analiseFinal.comentario ? `
                                    <div class="comentario-analista-destaque">
                                        <strong>Comentário Final:</strong>
                                        <p>"${analiseFinal.comentario}"</p>
                                    </div>
                                ` : ''}
                                ${linksAnaliseFinalHTML} <!-- AQUI MOSTRAMOS OS LINKS -->
                            </div>`;
                    }

                modalBody.innerHTML = `
                    <div class="info-block">
                        <h4>${resposta.requisito.texto}</h4>
                        <h5>Resposta Original da Secretaria</h5>
                        ${originalAnswerHTML}
                        ${resposta.comentarioSecretaria ? `<p><strong>Comentário Original:</strong> "${resposta.comentarioSecretaria}"</p>` : ''}
                        ${originalEvidencesHTML}
                    </div>
                    ${primeiraAnaliseHTML}
                    ${recursoHTML}
                    ${analiseFinalHTML}
                    <div id="modal-validation-wrapper" style="margin-top: 30px;">
                        <button id="editar-analise-final-btn" class="btn" aria-label="Editar análise final deste requisito">
                            ${temAnaliseFinalRealizada ? 'Alterar Análise' : 'Realizar Análise Final'}
                        </button>
                        <div id="modal-validation-interface" style="display: none; margin-top: 20px;">
                            ${construirInterfaceValidacaoModal(resposta)}
                        </div>
                    </div>
                `;

                modalOverlay.style.display = 'flex';
                setTimeout(() => modalContent.focus(), 100);

                configurarModalListeners();
            }


            //FUNÇÃO: Configurar listeners do modal 
            function configurarModalListeners() {
                const editarBtn = document.getElementById('editar-analise-final-btn');
                const validationInterface = document.getElementById('modal-validation-interface');
                const cancelarBtn = document.getElementById('cancelar-edicao-btn');
                const salvarBtn = document.getElementById('salvar-analise-final-btn');

                if (editarBtn) {
                    editarBtn.onclick = () => {
                        const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);
                        const isInterfaceAberta = validationInterface.style.display === 'block';

                        if (!isInterfaceAberta) {
                            validationInterface.innerHTML = construirInterfaceValidacaoModal(resposta);
                            configurarListenersInternosModal();
                            validationInterface.style.display = 'block';
                            editarBtn.textContent = 'Fechar Edição';
                            isModalEditing = true;
                            modalHasChanges = false;
                        } else {
                            if (modalHasChanges) {
                                Swal.fire({
                                    title: 'Descartar Alterações?',
                                    text: 'Você tem alterações não salvas na análise final. Deseja descartá-las e fechar a edição?',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: 'Sim, descartar',
                                    cancelButtonText: 'Continuar editando',
                                    confirmButtonColor: 'var(--vermelho-destaque)', 
                                    cancelButtonColor: 'var(--azul-gov-principal)'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        validationInterface.style.display = 'none'; 
                                        const mainEditBtn = document.getElementById('editar-analise-final-btn');
                                        const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);
                                        if(mainEditBtn && resposta) {
                                            mainEditBtn.textContent = (resposta.analiseFinal?.statusValidacaoPosRecurso && resposta.analiseFinal?.statusValidacaoPosRecurso !== 'pendente')
                                                                       ? 'Alterar Análise'
                                                                       : 'Realizar Análise Final';
                                        }
                                        isModalEditing = false;
                                        modalHasChanges = false; 

                                    }
                                });
                            } else {
                                validationInterface.style.display = 'none';
                                const mainEditBtn = document.getElementById('editar-analise-final-btn');
                                const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);
                                if(mainEditBtn && resposta) {
                                     mainEditBtn.textContent = (resposta.analiseFinal?.statusValidacaoPosRecurso && resposta.analiseFinal?.statusValidacaoPosRecurso !== 'pendente')
                                                              ? 'Alterar Análise'
                                                              : 'Realizar Análise Final';
                                }
                                isModalEditing = false;
                                modalHasChanges = false;
                            }
                        }
                    };
                }

                function configurarListenersInternosModal() {
                    const cancelarBtnInterno = document.getElementById('cancelar-edicao-btn');
                    const salvarBtnInterno = document.getElementById('salvar-analise-final-btn');
                    const botoesValidacaoInternos = modalBody.querySelectorAll('.btn-toggle');
                    const comentarioTextareaInterno = document.getElementById('modal-analise-final-comment');
                    const linksDisplay = modalBody.querySelector('#modal-links-analise-final-display');

                    if (cancelarBtnInterno) {
                        cancelarBtnInterno.onclick = () => {
                            if (modalHasChanges) {
                                Swal.fire({
                                    title: 'Cancelar Edição?',
                                    text: 'Todas as alterações não salvas na análise final serão perdidas.',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: 'Sim, cancelar',
                                    cancelButtonText: 'Continuar editando',
                                    confirmButtonColor: 'var(--vermelho-destaque)',
                                    cancelButtonColor: 'var(--azul-gov-principal)'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        validationInterface.style.display = 'none'; 
                                        const editarBtn = document.getElementById('editar-analise-final-btn');
                                        const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);
                                        if(editarBtn && resposta) {
                                                editarBtn.textContent = (resposta.analiseFinal?.statusValidacaoPosRecurso && resposta.analiseFinal?.statusValidacaoPosRecurso !== 'pendente')
                                                                    ? 'Alterar Análise'
                                                                    : 'Realizar Análise Final';
                                        }
                                        isModalEditing = false; 
                                        modalHasChanges = false; 
                                    }
                                });
                            } else {
                                validationInterface.style.display = 'none';
                                const editarBtn = document.getElementById('editar-analise-final-btn');
                                const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);
                                if(editarBtn && resposta) {
                                    editarBtn.textContent = (resposta.analiseFinal?.statusValidacaoPosRecurso && resposta.analiseFinal?.statusValidacaoPosRecurso !== 'pendente')
                                                        ? 'Alterar Análise'
                                                        : 'Realizar Análise Final';
                                }
                                isModalEditing = false;
                                modalHasChanges = false;
                            }
                        };
                    }
                    
                    if (salvarBtnInterno) { salvarBtnInterno.onclick = salvarAnaliseFinal; }

                    botoesValidacaoInternos.forEach(botao => {
                        botao.onclick = (e) => {
                            modalHasChanges = true;
                            const action = e.target.getAttribute('data-action');
                            const validationType = e.target.getAttribute('data-validation-type');
                            const grupoBotoes = modalBody.querySelectorAll(`[data-validation-type="${validationType}"]`);
                            
                            const decisaoAtual = grupoBotoes[0].classList.contains('active') ? 
                                                (grupoBotoes[0].getAttribute('data-action').includes('atende') ? 'aprovado' : 'rejeitado') : 
                                                (grupoBotoes[1].classList.contains('active') ? 
                                                (grupoBotoes[1].getAttribute('data-action').includes('atende') ? 'aprovado' : 'rejeitado') : 'pendente');
                            
                            const novaDecisao = action.includes('atende') ? 'aprovado' : 'rejeitado';
                            const decisaoMudou = decisaoAtual !== 'pendente' && decisaoAtual !== novaDecisao;

                            if (decisaoMudou && linksDisplay) {
                                console.log(`🔄 Mudança de decisão detectada: ${decisaoAtual} → ${novaDecisao}. Resetando links...`);
                                
                                Swal.fire({
                                    title: 'Mudança de Decisão',
                                    text: 'Os links de referência serão resetados para garantir consistência com a nova decisão.',
                                    icon: 'info',
                                    confirmButtonText: 'Entendido',
                                    confirmButtonColor: 'var(--azul-gov-principal)'
                                }).then(() => {
                                    linksDisplay.innerHTML = '<span style="font-size: 0.85em; color: #6c757d;">Nenhum link adicionado.</span>';
                                });
                            }

                            grupoBotoes.forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                            atualizarBadgeStatusModal(validationType, action.includes('atende'));
                        };
                    });

                    if (comentarioTextareaInterno) {
                        comentarioTextareaInterno.oninput = () => { modalHasChanges = true; };
                    }

                    configurarLinksAnaliseFinalModal();
                }

                configurarListenersInternosModal();
            }


            function atualizarBadgeStatusModal(validationType, atende) {
                const statusFinalProvisorio = atende ? 'aprovado' : 'rejeitado';
                const badge = modalBody.querySelector('.status-validacao'); 
                const resposta = avaliacaoCompleta.respostas.find(r => r.id === currentModalRespostaId);

                if (badge && resposta) {
                    const textoStatus = statusFinalProvisorio === 'aprovado' ? 'Aprovado' : 'Rejeitado';
                    const corStatus = determinarStatusRecurso(resposta, statusFinalProvisorio);

                    badge.textContent = textoStatus; 
                    badge.className = `status-validacao status-${corStatus}`; 
                }    
            }

            function configurarLinksAnaliseFinalModal() {
                const btnAddLink = modalBody.querySelector('.btn-add-link-analista-final');
                const linksDisplay = modalBody.querySelector('#modal-links-analise-final-display');

                if (btnAddLink) {
                    btnAddLink.onclick = async () => {
                        const { value: url } = await Swal.fire({
                            title: 'Adicionar Link de Referência da Análise Final',
                            input: 'url',
                            inputLabel: 'URL do Link',
                            inputPlaceholder: 'https://exemplo.com',
                            showCancelButton: true,
                            confirmButtonText: 'Adicionar Link',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: 'var(--azul-gov-principal)',
                            inputValidator: (value) => {
                                if (!value) { return 'Você precisa digitar um endereço web!'; }
                                if (!value.includes('.')) { return 'Insira um endereço válido (ex: www.exemplo.com)'; }
                                return null;
                            },
                            preConfirm: (value) => {
                                let finalUrl = value.trim();
                                if (!/^(https?:\/\/|\/\/)/i.test(finalUrl)) {
                                    finalUrl = 'https://' + finalUrl;
                                }
                                return finalUrl;
                            }
                        });

                        if (url && linksDisplay) {
                            const noLinksMessage = linksDisplay.querySelector('span');
                            if (noLinksMessage) {
                                noLinksMessage.remove();
                            }

                            const newLinkItem = document.createElement('div');
                            newLinkItem.className = 'evidence-item';
                            newLinkItem.setAttribute('data-link', url);
                            newLinkItem.innerHTML = `
                                <a href="${url}" target="_blank" title="${url}">${url}</a>
                                <button class="remove-evidence-btn remove-link-analista-btn" 
                                        data-link="${url}" 
                                        title="Remover Link">&times;</button>
                            `;

                            linksDisplay.appendChild(newLinkItem);
                            modalHasChanges = true;
                            
                            const removeBtn = newLinkItem.querySelector('.remove-link-analista-btn');
                            if (removeBtn) {
                                removeBtn.onclick = (e) => {
                                    e.preventDefault();
                                    newLinkItem.remove();
                                    modalHasChanges = true;
                                    
                                    if (linksDisplay.querySelectorAll('.evidence-item').length === 0) {
                                        linksDisplay.innerHTML = '<span style="font-size: 0.85em; color: #6c757d;">Nenhum link adicionado.</span>';
                                    }
                                };
                            }

                            Swal.fire({ 
                                toast: true, 
                                position: 'top-end', 
                                icon: 'success', 
                                title: 'Link adicionado!', 
                                showConfirmButton: false, 
                                timer: 1500 
                            });
                        }
                    };
                }

                // Configurar eventos de remoção para links existentes
                linksDisplay.querySelectorAll('.remove-link-analista-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const item = e.target.closest('.evidence-item');
                        if (item) {
                            item.remove();
                            modalHasChanges = true;
                            
                            if (linksDisplay.querySelectorAll('.evidence-item').length === 0) {
                                linksDisplay.innerHTML = '<span style="font-size: 0.85em; color: #6c757d;">Nenhum link adicionado.</span>';
                            }
                        }
                    };
                });
            }

            async function salvarAnaliseFinal() {
                const respostaId = currentModalRespostaId;
                const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                if (!resposta) return;

                try {
                    const btnNaoAtende = modalBody.querySelector('.btn-toggle[data-action="nao-atende-final"]');
                    const btnAtende = modalBody.querySelector('.btn-toggle[data-action="atende-final"]');

                    let decisaoFinal = 'pendente'; 
                    if (btnNaoAtende && btnNaoAtende.classList.contains('active')) {
                        decisaoFinal = 'rejeitado';
                    } else if (btnAtende && btnAtende.classList.contains('active')) {
                        decisaoFinal = 'aprovado';
                    } else {
                        decisaoFinal = resposta.analiseFinal?.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';
                    }

                    const linksAnaliseFinal = [];
                    const linksDisplay = modalBody.querySelector('#modal-links-analise-final-display');
                    if (linksDisplay) {
                        linksDisplay.querySelectorAll('.evidence-item').forEach(item => {
                            const link = item.querySelector('a')?.href;
                            if (link && link.trim() !== '') {
                                linksAnaliseFinal.push(link);
                            }
                        });
                    }

                    console.log('Links coletados para envio:', linksAnaliseFinal);

                    let payload = {
                        analiseFinal: {
                            comentario: document.getElementById('modal-analise-final-comment')?.value || '',
                            statusValidacaoPosRecurso: decisaoFinal 
                        },
                        comentarioAnaliseFinal: document.getElementById('modal-analise-final-comment')?.value || '', 
                        linksAnaliseFinal: linksAnaliseFinal,
                        atende: (decisaoFinal === 'aprovado')
                    };

                    console.log('Enviando análise final com payload:', JSON.stringify(payload));

                    const statusBadge = modalBody.querySelector('.validation-actions .status-validacao');
                    let originalBadgeText = '';
                    let originalBadgeClass = '';
                    if(statusBadge) {
                        originalBadgeText = statusBadge.textContent;
                        originalBadgeClass = statusBadge.className;
                        statusBadge.textContent = 'Salvando...';
                        statusBadge.className = 'status-validacao status-pendente'; 
                    }

                    const response = await fetch(`/api/respostas/${respostaId}/analise-final`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if(statusBadge) {
                            statusBadge.textContent = originalBadgeText;
                            statusBadge.className = originalBadgeClass;
                        }
                        throw new Error(errorData.error || 'Falha ao salvar a análise final.');
                    }

                    const respostaAtualizada = await response.json();
                    console.log('✅ Resposta do backend:', respostaAtualizada);

                    const index = avaliacaoCompleta.respostas.findIndex(r => r.id === respostaId);
                    if (index !== -1) {
                        avaliacaoCompleta.respostas[index] = {
                            ...avaliacaoCompleta.respostas[index],
                            analiseFinal: respostaAtualizada.analiseFinal || {},
                            comentarioAnaliseFinal: respostaAtualizada.comentarioAnaliseFinal, 
                            linksAnaliseFinal: respostaAtualizada.linksAnaliseFinal || [],
                            atende: respostaAtualizada.atende
                        };
                    }

                    recalcularEExibirPontuacoes(); 

                    Swal.fire({
                        toast: true, 
                        position: 'top-end', 
                        icon: 'success',
                        title: 'Análise Final Salva!', 
                        showConfirmButton: false, 
                        timer: 1500
                    }).then(() => {
                        window.location.reload();
                    });

                    document.getElementById('modal-validation-interface').style.display = 'none';
                    const editarBtn = document.getElementById('editar-analise-final-btn');
                    if(editarBtn) editarBtn.textContent = 'Alterar Análise Final'; 
                    isModalEditing = false;
                    modalHasChanges = false;

                } catch (error) {
                    console.error('❌ Erro ao salvar análise final:', error);
                    const statusBadgeOnError = modalBody.querySelector('.validation-actions .status-validacao');
                    if(statusBadgeOnError) {
                        const statusAnterior = resposta.analiseFinal?.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';
                        atualizarBadgeStatusModal('normal', statusAnterior === 'aprovado'); 
                    }

                    Swal.fire({
                        title: 'Erro!',
                        text: error.message || 'Não foi possível salvar a análise final.',
                        icon: 'error',
                        confirmButtonColor: 'var(--vermelho-destaque)'
                    });
                }
            }


            function fecharModal() {
                if (isModalEditing && modalHasChanges) {
                    Swal.fire({
                        title: 'Sair sem salvar?',
                        text: 'Você tem alterações não salvas na análise final. Deseja fechar mesmo assim?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, fechar',
                        cancelButtonText: 'Continuar editando',
                        confirmButtonColor: 'var(--vermelho-destaque)', 
                        cancelButtonColor: 'var(--azul-gov-principal)'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            modalOverlay.style.display = 'none'; 
                            currentModalRespostaId = null; 
                            isModalEditing = false; 
                            modalHasChanges = false;
                        }
                    });
                } else {
                    modalOverlay.style.display = 'none';
                    currentModalRespostaId = null;
                    isModalEditing = false;
                    modalHasChanges = false;
                }
            }

            // FUNÇÃO: Construir interface de análise final aberta para requisitos alterados (simplificada)
            function construirInterfaceAnaliseFinalAberta(resposta) {
                const analiseFinal = resposta.analiseFinal || {};
                const statusFinalAtual = analiseFinal.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';


                 let originalAnswerHTML = `
                    <p><strong>Resposta:</strong>
                        <span class="atende-badge ${resposta.atendeOriginal ? 'atende-sim' : 'atende-nao'}">
                            ${resposta.atendeOriginal ? 'Atende' : 'Não Atende'}
                        </span>
                    </p>`;

                const evidenciasOriginais = Array.isArray(resposta.evidencias) ? resposta.evidencias.filter(e => e.tipo === 'original') : [];
                let originalEvidencesHTML = '';
                if (resposta.linkComprovante || evidenciasOriginais.length > 0) {
                    originalEvidencesHTML = `<div class="evidence-section"><h5>Evidências Originais:</h5><ul class="evidence-list">`;
                    if (resposta.linkComprovante) {
                        originalEvidencesHTML += `<li class="evidence-item"><a href="${resposta.linkComprovante}" target="_blank">${resposta.linkComprovante}</a> (Link Comprovante)</li>`;
                    }
                    evidenciasOriginais.forEach(ev => {
                        originalEvidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`;
                    });
                    originalEvidencesHTML += `</ul></div>`;
                }

                const statusPrimeiraAnalise = resposta.statusValidacao || 'pendente';
                const statusTextoPrimeiraAnalise = statusPrimeiraAnalise === 'pendente' ? 'Pendente' :
                    (resposta.atendeOriginal === (statusPrimeiraAnalise === 'aprovado') ? 'Mantido' : 'Alterado');
                 const statusClassePrimeiraAnalise = statusPrimeiraAnalise === 'pendente' ? 'pendente' : (statusPrimeiraAnalise === 'aprovado' ? 'aprovado' : 'rejeitado');


                let primeiraAnaliseHTML = `
                    <div class="info-block">
                        <h5>1ª Análise da SCGE</h5>
                        <p><strong>Resultado:</strong>
                            <span class="status-validacao status-${statusClassePrimeiraAnalise}">${statusTextoPrimeiraAnalise}</span>
                        </p>
                        ${resposta.comentarioAdmin ? `
                            <p><strong>Comentário da 1ª análise:</strong> "${resposta.comentarioAdmin}"</p>
                        ` : ''}
                    </div>`;

                let recursoHTML = '';
                const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                    resposta.comentarioRecurso ||
                                    (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));


                if (teveRecurso) {
                    let recursoAnswerHTML = `
                        <p><strong>Nova Resposta (Recurso):</strong>
                            <span class="atende-badge ${resposta.atende ? 'atende-sim' : 'atende-nao'}">
                                ${resposta.atende ? 'Atende' : 'Não Atende'}
                            </span>
                        </p>`;

                    const evidenciasRecurso = Array.isArray(resposta.evidencias) ? resposta.evidencias.filter(e => e.tipo === 'recurso') : [];
                    let recursoEvidencesHTML = '';
                    if (evidenciasRecurso.length > 0 || resposta.linkComprovanteRecurso) {
                        recursoEvidencesHTML = `<div class="evidence-section"><h5>Evidências do Recurso:</h5><ul class="evidence-list">`;
                        if (resposta.linkComprovanteRecurso) {
                            recursoEvidencesHTML += `<li class="evidence-item"><a href="${resposta.linkComprovanteRecurso}" target="_blank">${resposta.linkComprovanteRecurso}</a> (Comprovante Recurso)</li>`;
                        }
                        evidenciasRecurso.forEach(ev => {
                            recursoEvidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`;
                        });
                        recursoEvidencesHTML += `</ul></div>`;
                    }

                    recursoHTML = `
                        <div class="info-block">
                            <h5>Recurso Submetido pela Secretaria</h5>
                            ${recursoAnswerHTML}
                            ${resposta.comentarioRecurso ? `<p><strong>Justificativa do Recurso:</strong> "${resposta.comentarioRecurso}"</p>` : ''}
                            ${recursoEvidencesHTML}
                        </div>`;
                }

                let analiseFinalInterface = `
                    <div class="validation-section">
                        <h4>Análise Final (Pós-Recurso)</h4>
                        <p style="margin-bottom: 15px; color: #666;">Realize ou ajuste a análise final abaixo:</p>

                        <textarea class="admin-comment analise-final-comment" data-resposta-id="${resposta.id}"
                                placeholder="Adicionar comentário final para o requisito...">${analiseFinal.comentario || ''}</textarea>

                        <div class="validation-actions">
                             <span class="status-validacao status-${determinarStatusRecurso(resposta, statusFinalAtual)}">
                                ${determinarTextoStatusRecurso(resposta, statusFinalAtual)} (${statusFinalAtual === 'aprovado' ? 'Aprovado' : statusFinalAtual === 'rejeitado' ? 'Rejeitado' : 'Pendente'})
                             </span>
                             <button class="btn-toggle ${statusFinalAtual === 'rejeitado' ? 'active' : ''}"
                                    data-action="nao-atende-final" data-validation-type="normal">Não Atende</button>
                            <button class="btn-toggle ${statusFinalAtual === 'aprovado' ? 'active' : ''}"
                                    data-action="atende-final" data-validation-type="normal">Atende</button>
                        </div>
                    </div>`;


                return `
                    <div class="info-block">
                        <h5>Resposta Original da Secretaria</h5>
                        ${originalAnswerHTML}
                        ${resposta.comentarioSecretaria ? `<p><strong>Comentário Original:</strong> "${resposta.comentarioSecretaria}"</p>` : ''}
                        ${originalEvidencesHTML}
                    </div>
                    ${primeiraAnaliseHTML}
                    ${recursoHTML}
                    ${analiseFinalInterface}
                `;
            }

            function renderizarRequisitoComposto(resposta) {
                const subRespostas = resposta.subRespostas || [];
                
                const aprovadosFinal = subRespostas.filter(s => 
                    (s.statusValidacaoPosRecurso || s.statusValidacao) === 'aprovado'
                ).length;
                const total = subRespostas.length;
                const pontuacaoBase = resposta.requisito?.pontuacao || 8;
                
                let pontuacaoFinal = 0;
                if (aprovadosFinal >= 12) pontuacaoFinal = pontuacaoBase;
                else if (aprovadosFinal >= 8) pontuacaoFinal = pontuacaoBase * 0.7;
                else if (aprovadosFinal >= 4) pontuacaoFinal = pontuacaoBase * 0.5;
                else if (aprovadosFinal >= 1) pontuacaoFinal = pontuacaoBase * 0.3;
                
                let statusClass = 'summary-status-pendente';
                let statusTexto = 'PENDENTE';
                
                if (aprovadosFinal === total) {
                    statusClass = 'summary-status-mantido';
                    statusTexto = `COMPLETO (${pontuacaoFinal.toFixed(1)}/${pontuacaoBase})`;
                } else if (aprovadosFinal === 0) {
                    statusClass = 'summary-status-nao-atende';
                    statusTexto = `NENHUM (0/${pontuacaoBase})`;
                } else {
                    statusClass = 'summary-status-alterado-rejeitado';
                    statusTexto = `${aprovadosFinal}/${total} (${pontuacaoFinal.toFixed(1)}/${pontuacaoBase})`;
                }

                return `
                <div class="resposta-card" data-resposta-id="${resposta.id}" data-tipo="composto">
                    <div class="resposta-header">
                        <strong>${resposta.requisito.texto}</strong>
                        <span class="summary-status-badge ${statusClass}">
                            ${statusTexto}
                        </span>
                    </div>
                    
                    <div class="resposta-body">
                        <!-- Comentário da Secretaria -->
                        ${resposta.comentarioSecretaria ? `
                        <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-left:4px solid var(--azul-gov-principal);">
                            <strong>Comentário da Secretaria:</strong>
                            <p style="margin:5px 0 0 0;">"${resposta.comentarioSecretaria}"</p>
                        </div>
                        ` : ''}

                        <!-- Comentário da 1ª Análise -->
                        ${resposta.comentarioAdmin ? `
                        <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-left:4px solid var(--amarelo-gov-detalhe);">
                            <strong>Comentário da 1ª Análise:</strong>
                            <p style="margin:5px 0 0 0;">"${resposta.comentarioAdmin}"</p>
                        </div>
                        ` : ''}

                        <!-- Tabela de Subitens -->
                        <table class="subitens-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Subitem</th>
                                    <th>Resposta</th>
                                    <th>Link</th>
                                    <th>1ª Análise</th>
                                    <th>Recurso</th>
                                    <th>Análise Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subRespostas.map((sub, index) => {
                                    const primeiraAnaliseClass = sub.statusValidacao === 'aprovado' ? 'atende-sim' : 
                                                                (sub.statusValidacao === 'rejeitado' ? 'atende-nao' : 'status-pendente');
                                    const primeiraAnaliseText = sub.statusValidacao === 'aprovado' ? 'Aprovado' :
                                                            (sub.statusValidacao === 'rejeitado' ? 'Rejeitado' : 'Pendente');

                                    const recursoClass = sub.recursoAtende === true ? 'atende-sim' :
                                                    (sub.recursoAtende === false ? 'atende-nao' : 'status-pendente');
                                    const recursoText = sub.recursoAtende === true ? 'Atende' :
                                                    (sub.recursoAtende === false ? 'Não' : '—');

                                    const statusFinalAtual = sub.statusValidacaoPosRecurso || sub.statusValidacao || 'pendente';
                                    
                                    return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${sub.subRequisito.texto}</td>
                                        <td>
                                            <span class="atende-badge ${sub.atende ? 'atende-sim' : 'atende-nao'}" style="font-size:0.75em;">
                                                ${sub.atende ? 'Atende' : 'Não'}
                                            </span>
                                        </td>
                                        <td>
                                            ${sub.linkComprovante ? 
                                                `<a href="${sub.linkComprovante}" target="_blank" style="word-break:break-all;">${sub.linkComprovante.substring(0,30)}...</a>` : 
                                                '<span style="color:#999;">—</span>'}
                                        </td>
                                        <td>
                                            <span class="atende-badge ${primeiraAnaliseClass}" style="font-size:0.75em;">
                                                ${primeiraAnaliseText}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="atende-badge ${recursoClass}" style="font-size:0.75em;">
                                                ${recursoText}
                                            </span>
                                        </td>
                                        <td>
                                            <select class="subitem-validacao" data-subresposta-id="${sub.id}" 
                                                    style="width:100%; padding:4px;">
                                                <option value="pendente" ${statusFinalAtual === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="aprovado" ${statusFinalAtual === 'aprovado' ? 'selected' : ''}>Aprovar</option>
                                                <option value="rejeitado" ${statusFinalAtual === 'rejeitado' ? 'selected' : ''}>Rejeitar</option>
                                            </select>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>

                        <!-- Campo para comentário final -->
                        <textarea class="admin-comment analise-final-comment" 
                                placeholder="Comentário final sobre o requisito..." 
                                style="width:100%; margin-top:15px;">${resposta.comentarioAnaliseFinal || ''}</textarea>
                    </div>
                </div>`;
            }

            function configurarListenersSubitens() {
                // Selects de validação dos subitens
                document.querySelectorAll('.subitem-validacao').forEach(select => {
                    const novoSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(novoSelect, select);

                    novoSelect.addEventListener('change', async function() {
                        const subRespostaId = this.dataset.subrespostaId;
                        const status = this.value;
                        
                        this.disabled = true;

                        try {
                            const response = await fetch(`/api/subrespostas/${subRespostaId}/validar-recurso`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${authToken}`
                                },
                                body: JSON.stringify({ statusValidacaoPosRecurso: status })
                            });

                            if (response.ok) {
                                // Atualizar dados locais
                                const respostaIndex = avaliacaoCompleta.respostas.findIndex(r => 
                                    r.subRespostas?.some(s => s.id === parseInt(subRespostaId))
                                );
                                
                                if (respostaIndex !== -1) {
                                    const subIndex = avaliacaoCompleta.respostas[respostaIndex].subRespostas.findIndex(s => s.id === parseInt(subRespostaId));
                                    if (subIndex !== -1) {
                                        avaliacaoCompleta.respostas[respostaIndex].subRespostas[subIndex].statusValidacaoPosRecurso = status;
                                    }
                                }

                                // 🔥 Recalcular e exibir as notas
                                exibirQuatroNotas();
                                
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'success',
                                    title: 'Análise final salva!',
                                    showConfirmButton: false,
                                    timer: 1500
                                });
                            }
                        } catch (error) {
                            console.error('Erro:', error);
                            Swal.fire('Erro!', 'Não foi possível salvar.', 'error');
                        } finally {
                            this.disabled = false;
                        }
                    });
                });

                // Comentários finais
                document.querySelectorAll('.analise-final-comment').forEach(textarea => {
                    const novoTextarea = textarea.cloneNode(true);
                    textarea.parentNode.replaceChild(novoTextarea, textarea);

                    let timeout;
                    novoTextarea.addEventListener('input', function() {
                        clearTimeout(timeout);
                        const card = this.closest('.resposta-card');
                        const respostaId = card.dataset.respostaId;
                        const comentario = this.value;

                        timeout = setTimeout(async () => {
                            try {
                                await fetch(`/api/respostas/${respostaId}`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`
                                    },
                                    body: JSON.stringify({ comentarioAnaliseFinal: comentario })
                                });
                            } catch (error) {
                                console.error('Erro ao salvar comentário:', error);
                            }
                        }, 500);
                    });
                });
            }

            function renderizarRequisitoCompostoAnaliseFinal(resposta) {
                const subRespostas = resposta.subRespostas || [];
                
                const aprovadosFinal = subRespostas.filter(s => 
                    (s.statusValidacaoPosRecurso || s.statusValidacao) === 'aprovado'
                ).length;
                const total = subRespostas.length;
                const pontuacaoBase = resposta.requisito?.pontuacao || 8;
                
                let pontuacaoFinal = 0;
                if (aprovadosFinal >= 12) pontuacaoFinal = pontuacaoBase;
                else if (aprovadosFinal >= 8) pontuacaoFinal = pontuacaoBase * 0.7;
                else if (aprovadosFinal >= 4) pontuacaoFinal = pontuacaoBase * 0.5;
                else if (aprovadosFinal >= 1) pontuacaoFinal = pontuacaoBase * 0.3;
                
                let statusClass = 'summary-status-pendente';
                let statusTexto = 'PENDENTE';
                
                if (aprovadosFinal === total) {
                    statusClass = 'summary-status-mantido';
                    statusTexto = `COMPLETO (${pontuacaoFinal.toFixed(1)}/${pontuacaoBase})`;
                } else if (aprovadosFinal === 0) {
                    statusClass = 'summary-status-nao-atende';
                    statusTexto = `NENHUM (0/${pontuacaoBase})`;
                } else {
                    statusClass = 'summary-status-alterado-rejeitado';
                    statusTexto = `${aprovadosFinal}/${total} (${pontuacaoFinal.toFixed(1)}/${pontuacaoBase})`;
                }

                const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                    resposta.comentarioRecurso ||
                                    (resposta.evidencias?.some(e => e.tipo === 'recurso'));
                
                const badgeRecursoHTML = teveRecurso ? '<span class="recurso-badge">Recurso</span>' : '';

                return `
                <div class="resposta-card" data-resposta-id="${resposta.id}" data-tipo="composto">
                    <div class="resposta-header">
                        <strong>${resposta.requisito.texto}</strong>
                        <div class="summary-status-container">
                            <span class="summary-status-badge ${statusClass}">
                                ${statusTexto}
                            </span>
                            ${badgeRecursoHTML}
                        </div>
                    </div>
                    
                    <div class="resposta-body">
                        <!-- Comentário da Secretaria -->
                        ${resposta.comentarioSecretaria ? `
                        <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-left:4px solid var(--azul-gov-principal);">
                            <strong>Comentário da Secretaria:</strong>
                            <p style="margin:5px 0 0 0;">"${resposta.comentarioSecretaria}"</p>
                        </div>
                        ` : ''}

                        <!-- Comentário da 1ª Análise -->
                        ${resposta.comentarioAdmin ? `
                        <div style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-left:4px solid var(--amarelo-gov-detalhe);">
                            <strong>Comentário da 1ª Análise:</strong>
                            <p style="margin:5px 0 0 0;">"${resposta.comentarioAdmin}"</p>
                        </div>
                        ` : ''}

                        <!-- Tabela de Subitens -->
                        <table class="subitens-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Subitem</th>
                                    <th>Resposta</th>
                                    <th>Link</th>
                                    <th>1ª Análise</th>
                                    <th>Recurso</th>
                                    <th>Análise Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subRespostas.map((sub, index) => {
                                    const primeiraAnaliseClass = sub.statusValidacao === 'aprovado' ? 'atende-sim' : 
                                                                (sub.statusValidacao === 'rejeitado' ? 'atende-nao' : 'status-pendente');
                                    const primeiraAnaliseText = sub.statusValidacao === 'aprovado' ? 'Aprovado' :
                                                            (sub.statusValidacao === 'rejeitado' ? 'Rejeitado' : 'Pendente');

                                    const recursoClass = sub.recursoAtende === true ? 'atende-sim' :
                                                    (sub.recursoAtende === false ? 'atende-nao' : 'status-pendente');
                                    const recursoText = sub.recursoAtende === true ? 'Atende' :
                                                    (sub.recursoAtende === false ? 'Não' : '—');

                                    const statusFinalAtual = sub.statusValidacaoPosRecurso || sub.statusValidacao || 'pendente';
                                    
                                    return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${sub.subRequisito.texto}</td>
                                        <td>
                                            <span class="atende-badge ${sub.atende ? 'atende-sim' : 'atende-nao'}" style="font-size:0.75em;">
                                                ${sub.atende ? 'Atende' : 'Não'}
                                            </span>
                                        </td>
                                        <td>
                                            ${sub.linkComprovante ? 
                                                `<a href="${sub.linkComprovante}" target="_blank" style="word-break:break-all;">${sub.linkComprovante.substring(0,30)}...</a>` : 
                                                '<span style="color:#999;">—</span>'}
                                        </td>
                                        <td>
                                            <span class="atende-badge ${primeiraAnaliseClass}" style="font-size:0.75em;">
                                                ${primeiraAnaliseText}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="atende-badge ${recursoClass}" style="font-size:0.75em;">
                                                ${recursoText}
                                            </span>
                                        </td>
                                        <td>
                                            <select class="subitem-validacao" data-subresposta-id="${sub.id}" 
                                                    style="width:100%; padding:4px;">
                                                <option value="pendente" ${statusFinalAtual === 'pendente' ? 'selected' : ''}>Pendente</option>
                                                <option value="aprovado" ${statusFinalAtual === 'aprovado' ? 'selected' : ''}>Aprovar</option>
                                                <option value="rejeitado" ${statusFinalAtual === 'rejeitado' ? 'selected' : ''}>Rejeitar</option>
                                            </select>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>

                        <!-- Campo para comentário final -->
                        <textarea class="admin-comment analise-final-comment" 
                                placeholder="Comentário final sobre o requisito..." 
                                style="width:100%; margin-top:15px;">${resposta.comentarioAnaliseFinal || ''}</textarea>
                    </div>
                </div>`;
            }

            function renderizarCardsDeResposta() {
                if (!avaliacaoCompleta || !Array.isArray(avaliacaoCompleta.respostas)) {
                    respostasContainer.innerHTML = '<p>Nenhuma resposta encontrada.</p>';
                    return;
                }

                respostasContainer.innerHTML = avaliacaoCompleta.respostas.map(resposta => {
                    if (resposta.subRespostas && resposta.subRespostas.length > 0) {
                        return renderizarRequisitoCompostoAnaliseFinal(resposta);
                    }

                    const analiseFinal = resposta.analiseFinal || {};
                    let cardClass = '';
                    let statusTexto = '';
                    let statusClass = '';
                    let tooltipTexto = '';
                    let deveFicarAberto = false;
                    let badgeRecursoHTML = ''; 

                    const statusPrimeiraAnalise = resposta.statusValidacao || 'pendente';
                    const statusFinal = analiseFinal.statusValidacaoPosRecurso || statusPrimeiraAnalise;


                    const secretariaAtende = resposta.atendeOriginal === true; 
                    const scgePrimeiraAnaliseAtende = statusPrimeiraAnalise === 'aprovado';
                    const scgeFinalAtende = statusFinal === 'aprovado';

                    const houveAlteracaoPrimeiraAnalise = secretariaAtende !== scgePrimeiraAnaliseAtende;
                    const temAnaliseFinal = statusFinal !== 'pendente';

                    const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                        resposta.comentarioRecurso ||
                                        (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));

                     if (teveRecurso) {
                         badgeRecursoHTML = '<span class="recurso-badge">Recurso</span>';
                     }


                    if (temAnaliseFinal) {
                        if (scgeFinalAtende) {
                            cardClass = 'card-mantido-sim'; 
                            statusTexto = 'ATENDE';
                            statusClass = 'summary-status-mantido';
                            tooltipTexto = 'Requisito aprovado na análise final';
                        } else {
                            cardClass = 'card-mantido-nao'; 
                            statusTexto = 'NÃO ATENDE';
                            statusClass = 'summary-status-nao-atende';
                            tooltipTexto = 'Requisito rejeitado na análise final';
                        }
                        deveFicarAberto = false;
                    }
                    else if (houveAlteracaoPrimeiraAnalise) {
                        if (scgePrimeiraAnaliseAtende) { 
                            cardClass = 'card-alterado-aprovado'; 
                            statusTexto = 'ALTERADO (SCGE: Atende)';
                            statusClass = 'summary-status-alterado-aprovado';
                            tooltipTexto = 'Requisito alterado de "Não Atende" para "Atende" (1ª Análise)';
                            deveFicarAberto = false; 
                        } else { 
                            cardClass = 'card-alterado-rejeitado'; 
                            statusTexto = 'PENDENTE ANÁLISE FINAL';
                            statusClass = 'summary-status-alterado-rejeitado';
                            tooltipTexto = 'Requisito alterado de "Atende" para "Não Atende" - Aguardando análise final';
                            deveFicarAberto = true; 
                        }
                    } else { 
                        if (scgePrimeiraAnaliseAtende) { 
                            cardClass = 'card-mantido-sim'; 
                            statusTexto = 'MANTIDO (Atende)';
                            statusClass = 'summary-status-mantido';
                            tooltipTexto = 'Resposta mantida como "Atende"';
                            deveFicarAberto = false; 
                        } else { 
                            cardClass = 'card-mantido-nao'; 
                            statusTexto = 'MANTIDO (Não Atende)';
                            statusClass = 'summary-status-nao-atende';
                            tooltipTexto = 'Resposta mantida como "Não Atende"';
                            deveFicarAberto = false; 
                        }
                        if (teveRecurso && !temAnaliseFinal) {
                            statusTexto = 'PENDENTE ANÁLISE FINAL';
                            tooltipTexto += ' - Houve recurso, aguardando análise final';
                            statusClass = scgePrimeiraAnaliseAtende ? 'summary-status-mantido' : 'summary-status-nao-atende'; 
                            deveFicarAberto = true;
                        }
                    }


                    const respostaData = JSON.stringify(resposta).replace(/"/g, '&quot;');

                    const classeRecursoIndicador = teveRecurso ? 'card-com-recurso-indicador' : '';

                    if (deveFicarAberto) {
                        let analiseFinalInterface = construirInterfaceAnaliseFinalAberta(resposta);
                        return `
                            <div class="resposta-card ${cardClass} ${classeRecursoIndicador}" data-resposta-id="${resposta.id}" data-resposta='${respostaData}' role="article">
                                <div class="resposta-header">
                                    <strong>${resposta.requisito.texto}</strong>
                                     <div class="summary-status-container"> 
                                        <span class="tooltip summary-status-badge ${statusClass}" title="${tooltipTexto}">
                                            ${statusTexto}
                                        </span>
                                        ${badgeRecursoHTML} 
                                     </div>
                                </div>
                                <div class="resposta-body">
                                    ${analiseFinalInterface}
                                </div>
                            </div>`;
                    } else {
                        return `
                            <div class="resposta-card ${cardClass} ${classeRecursoIndicador}" data-resposta='${respostaData}' role="article">
                                <div class="summary-header" tabindex="0" role="button" aria-expanded="false">
                                    <strong>${resposta.requisito.texto}</strong>
                                     <div class="summary-status-container"> 
                                        <span class="tooltip summary-status-badge ${statusClass}" title="${tooltipTexto}">
                                            ${statusTexto}
                                        </span>
                                         ${badgeRecursoHTML} 
                                     </div>
                                </div>
                            </div>`;
                    }
                }).join('');

                configurarListenersSalvarAutomatico();
            }

            // FUNÇÃO: Configurar botão de finalizar (COM VERIFICAÇÃO DE PENDÊNCIAS NO CLIQUE)
            function configurarBotaoFinal() {
                function precisaAnaliseFinal(resposta) {
                    const statusPrimeiraAnalise = resposta.statusValidacao || 'pendente';
                    const secretariaAtende = resposta.atendeOriginal === true;
                    const scgePrimeiraAnaliseAtende = statusPrimeiraAnalise === 'aprovado';
                    const secretariaAtendeSCGENaoAtende = secretariaAtende && !scgePrimeiraAnaliseAtende; 

                    const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                        resposta.comentarioRecurso ||
                                        (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));

                    return secretariaAtendeSCGENaoAtende || teveRecurso;
                }

                actionsContainer.innerHTML = `<button id="finalizar-btn" class="btn">Encerrar e Publicar Nota Final</button>`;
                const finalizarBtn = document.getElementById('finalizar-btn');

                finalizarBtn.addEventListener('click', async () => {
                    let pendentes = [];
                    if (avaliacaoCompleta && Array.isArray(avaliacaoCompleta.respostas)) {
                        pendentes = avaliacaoCompleta.respostas.filter(resposta => {
                            const necessita = precisaAnaliseFinal(resposta); 
                            const analiseFinal = resposta.analiseFinal || {};
                            const temAnalise = analiseFinal.statusValidacaoPosRecurso && analiseFinal.statusValidacaoPosRecurso !== 'pendente'; 

                            return necessita && !temAnalise;
                        });
                    }

                    if (pendentes.length > 0) {
                        const listaHtml = pendentes.map(p => {
                            const reqIdentifier = p.requisito?.numero ? `Requisito ${p.requisito.numero}` : (p.requisito?.texto?.substring(0, 50) + '...' || `ID ${p.id}`);
                            return `<li>${reqIdentifier}</li>`;
                        }).join('');

                        Swal.fire({
                            title: 'Análises Pendentes',
                            html: `Não é possível finalizar a avaliação pois a análise final dos seguintes requisitos ainda está pendente:
                                <ul style="text-align: left; margin-top: 15px; max-height: 200px; overflow-y: auto;">${listaHtml}</ul>
                                Por favor, revise e salve a análise final para cada um deles.`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: 'var(--azul-gov-principal)'
                        });
                        return; 
                    }

                    Swal.fire({
                        title: 'Encerrar Avaliação?',
                        text: "A nota final será calculada e publicada para a secretaria. Esta ação é definitiva.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, Encerrar e Publicar!',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: 'var(--azul-gov-principal)',
                        cancelButtonColor: '#6c757d'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            finalizarBtn.disabled = true;
                            finalizarBtn.textContent = 'Finalizando...';

                            try {
                                const response = await fetch(`/api/avaliacoes/${avaliacaoId}/finalizar`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${authToken}`,
                                        'Content-Type': 'application/json'
                                    }
                                });

                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    throw new Error(errorData.error || errorData.message || 'Falha ao finalizar a avaliação.');
                                }

                                const responseData = await response.json();
                                console.log('Avaliação finalizada com sucesso:', responseData);

                                await Swal.fire({
                                    title: 'Sucesso!',
                                    text: 'A avaliação foi finalizada e a nota publicada com sucesso.',
                                    icon: 'success',
                                    confirmButtonColor: 'var(--azul-gov-principal)'
                                });

                                window.location.href = `/nota-final/${avaliacaoId}`; 

                            } catch (error) {
                                console.error('Erro ao finalizar:', error);
                                Swal.fire({
                                    title: 'Erro!',
                                    text: error.message || 'Erro desconhecido ao finalizar a avaliação.',
                                    icon: 'error',
                                    confirmButtonColor: 'var(--vermelho-destaque)'
                                });
                                finalizarBtn.disabled = false; 
                                finalizarBtn.textContent = 'Encerrar e Publicar Nota Final';
                            }
                        }
                    });
                });
            }

            function adicionarEventListeners() {
                respostasContainer.addEventListener('click', (event) => {
                    if (event.target.closest('.validation-section') || event.target.closest('a')) {
                        return;
                    }

                    const card = event.target.closest('.resposta-card');
                    if (card && card.dataset.resposta) { 
                        try {
                            const resposta = JSON.parse(card.dataset.resposta.replace(/&quot;/g, '"'));
                            abrirModal(resposta);
                        } catch (e) {
                            console.error('Erro ao parsear resposta no listener do card:', e);
                        }
                    }
                });

                configurarListenersSalvarAutomatico(); 

                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && modalOverlay.style.display === 'flex') {
                        fecharModal();
                    }
                });
                modalOverlay.addEventListener('click', (event) => {
                    if (event.target === modalOverlay) {
                        fecharModal();
                    }
                });
                modalCloseBtn.addEventListener('click', fecharModal);
            }

            function configurarListenersSalvarAutomatico() {
                respostasContainer.querySelectorAll('.resposta-card .btn-toggle[data-action]').forEach(botao => {
                    const novoBotao = botao.cloneNode(true);
                    botao.parentNode.replaceChild(novoBotao, botao);

                    novoBotao.addEventListener('click', (event) => {
                        const card = event.target.closest('.resposta-card');
                        const respostaId = parseInt(card.dataset.respostaId);
                         if (!isNaN(respostaId)) {
                            const action = event.target.getAttribute('data-action');
                            const validationType = event.target.getAttribute('data-validation-type');
                            const container = event.target.closest('.sub-validation-container') || event.target.closest('.validation-actions');
                            const grupoBotoes = container.querySelectorAll(`[data-validation-type="${validationType}"]`);
                            grupoBotoes.forEach(btn => btn.classList.remove('active'));
                            event.target.classList.add('active');

                            salvarAnaliseFinalAberta(respostaId); 
                        }
                    });
                });

                respostasContainer.querySelectorAll('.resposta-card .analise-final-comment').forEach(textarea => {
                    const novoTextarea = textarea.cloneNode(true);
                    textarea.parentNode.replaceChild(novoTextarea, textarea);

                    let debounceTimeout;
                    novoTextarea.addEventListener('input', (event) => { 
                        clearTimeout(debounceTimeout);
                        debounceTimeout = setTimeout(() => {
                            const card = event.target.closest('.resposta-card');
                            const respostaId = parseInt(card.dataset.respostaId);
                            if (!isNaN(respostaId)) {
                                salvarAnaliseFinalAberta(respostaId);
                            }
                        }, 750); 
                    });
                });
            }

            function atualizarBadgeStatusAberto(card, statusFinal) {
                if (!card) return;
                const badge = card.querySelector('.validation-actions .status-validacao');
                const respostaId = parseInt(card.dataset.respostaId);
                const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);

                if (badge && resposta) {
                    const textoStatus = statusFinal === 'aprovado' ? 'Aprovado' : 'Rejeitado';
                    const corStatus = determinarStatusRecurso(resposta, statusFinal); 

                    badge.textContent = textoStatus; 
                    badge.className = `status-validacao status-${corStatus}`; 
                }
            }

            // FUNÇÃO para salvar análise final da interface ABERTA 
            async function salvarAnaliseFinalAberta(respostaId) {
                const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                if (!resposta) {
                    console.error('❌ Resposta não encontrada para salvar:', respostaId);
                    return;
                }

                const card = document.querySelector(`.resposta-card[data-resposta-id="${respostaId}"]`);
                if (!card) {
                    console.error('❌ Card não encontrado para salvar:', respostaId);
                    return;
                }

                try {
                    const btnNaoAtende = card.querySelector('.btn-toggle[data-action="nao-atende-final"]');
                    const btnAtende = card.querySelector('.btn-toggle[data-action="atende-final"]');

                    let decisaoFinal = 'pendente'; 
                    if (btnNaoAtende && btnNaoAtende.classList.contains('active')) {
                        decisaoFinal = 'rejeitado';
                    } else if (btnAtende && btnAtende.classList.contains('active')) {
                        decisaoFinal = 'aprovado';
                    } else {
                        decisaoFinal = resposta.analiseFinal?.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';
                        console.warn(`[Salvar Aberto - Revisado] Nenhum botão ativo detectado para ${respostaId}. Usando status fallback: ${decisaoFinal}`);
                    }

                    let payload = {
                        analiseFinal: {
                            comentario: card.querySelector('.analise-final-comment')?.value || '',
                            statusValidacaoPosRecurso: decisaoFinal 
                        },
                        atende: (decisaoFinal === 'aprovado')
                    };

                    console.log('📤 Salvando análise final aberta (REVISADO):', JSON.stringify(payload));

                    const statusBadge = card.querySelector('.validation-actions .status-validacao');
                    let originalBadgeText = '';
                    let originalBadgeClass = '';
                    if(statusBadge) {
                        originalBadgeText = statusBadge.textContent;
                        originalBadgeClass = statusBadge.className;
                        statusBadge.textContent = 'Salvando...';
                        statusBadge.className = 'status-validacao status-pendente';
                    }


                    const response = await fetch(`/api/respostas/${respostaId}/analise-final`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if(statusBadge) {
                            statusBadge.textContent = originalBadgeText;
                            statusBadge.className = originalBadgeClass;
                        }
                        throw new Error(errorData.error || 'Falha ao salvar a análise final.');
                    }

                    const respostaAtualizada = await response.json();
                    console.log('✅ Resposta do backend (aberto):', respostaAtualizada);

                    const index = avaliacaoCompleta.respostas.findIndex(r => r.id === respostaId);
                    if (index !== -1) {
                        avaliacaoCompleta.respostas[index] = {
                            ...avaliacaoCompleta.respostas[index],
                            analiseFinal: respostaAtualizada.analiseFinal || {},
                            atende: respostaAtualizada.atende,
                            statusValidacaoPosRecurso: respostaAtualizada.analiseFinal?.statusValidacaoPosRecurso
                        };
                        avaliacaoCompleta.respostas[index].atendeOriginal = resposta.atendeOriginal;
                        console.log(`[Salvar Aberto - Revisado] Dados locais atualizados para ${respostaId}: atende=${respostaAtualizada.atende}, statusFinal=${respostaAtualizada.analiseFinal?.statusValidacaoPosRecurso}`);
                        card.dataset.resposta = JSON.stringify(avaliacaoCompleta.respostas[index]).replace(/"/g, '&quot;');
                    }

                    recalcularEExibirPontuacoes(); 
                    configurarBotaoFinal(); 

                    atualizarBadgeStatusAberto(card, payload.analiseFinal.statusValidacaoPosRecurso);

                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'success',
                        title: 'Salvo!', showConfirmButton: false, timer: 1000
                    });

                } catch (error) {
                    console.error('❌ Erro ao salvar análise final aberta:', error);
                    const statusBadgeOnError = card.querySelector('.validation-actions .status-validacao');
                    if(statusBadgeOnError) {
                        const statusAnterior = resposta.analiseFinal?.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';
                        atualizarBadgeStatusAberto(card, statusAnterior);
                    }

                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'error',
                        title: 'Erro ao salvar!', showConfirmButton: false, timer: 1500
                    });
                }
            }


            function atualizarInterfaceAposSalvamento(respostaId) {

                const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                const card = document.querySelector(`[data-resposta-id="${respostaId}"]`);
                if (!resposta || !card) return;

                const analiseFinal = resposta.analiseFinal || {};
                const statusFinal = analiseFinal.statusValidacaoPosRecurso || resposta.statusValidacao || 'pendente';
                const scgeFinalAtende = statusFinal === 'aprovado';

                const summaryBadge = card.querySelector('.summary-status-badge');
                if (summaryBadge) {
                    const novoStatusTexto = determinarTextoStatusRecurso(resposta, statusFinal);
                    const novoStatusClasseCor = determinarStatusRecurso(resposta, statusFinal); 
                    const aprovadoRejeitadoTexto = statusFinal === 'aprovado' ? 'Aprovado' : statusFinal === 'rejeitado' ? 'Rejeitado' : 'Pendente';
                    const novoTooltip = `${novoStatusTexto} (${aprovadoRejeitadoTexto})`;


                    summaryBadge.textContent = novoStatusTexto; 
                    summaryBadge.className = `tooltip summary-status-badge summary-status-${novoStatusClasseCor}`; 
                    summaryBadge.title = novoTooltip; 


                    card.className = card.className.replace(/card-mantido-\w+|card-alterado-\w+/g, ''); 
                    card.classList.add(scgeFinalAtende ? 'card-mantido-sim' : 'card-mantido-nao');
                }

                const badgeRecurso = card.querySelector('.recurso-badge');
                const teveRecurso = resposta.atende !== resposta.atendeOriginal ||
                                    resposta.comentarioRecurso ||
                                    (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));
                if (teveRecurso && !badgeRecurso) {
                    card.querySelector('.summary-status-container')?.insertAdjacentHTML('beforeend', '<span class="recurso-badge">Recurso</span>');
                } else if (!teveRecurso && badgeRecurso) {
                    badgeRecurso.remove();
                }

            }

            async function carregarDados() {
                try {
                    const response = await fetch(`/api/avaliacoes/${avaliacaoId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || errorData.message || 'Não foi possível carregar os dados da avaliação.');
                    }

                    avaliacaoCompleta = await response.json();

                    if (!Array.isArray(avaliacaoCompleta.respostas)) {
                        avaliacaoCompleta.respostas = [];
                    }

                    avaliacaoCompleta.respostas = avaliacaoCompleta.respostas.map(normalizarDadosResposta);
                    console.log("Dados normalizados:", avaliacaoCompleta.respostas); 


                    const dataFormatada = new Date(avaliacaoCompleta.createdAt).toLocaleString('pt-BR');
                    summaryContainer.innerHTML = `
                        <h1>Análise Final (Pós-Recurso)</h1>
                        <h2>${avaliacaoCompleta.secretaria.nome} (${avaliacaoCompleta.secretaria.sigla})</h2>
                        <div class="report-summary">
                            <span><strong>URL Avaliada:</strong> ${avaliacaoCompleta.urlSecretaria}</span>
                            <span><strong>Enviado em:</strong> ${dataFormatada}</span>
                            <span><strong>Responsável:</strong> ${avaliacaoCompleta.nomeResponsavel}</span>
                            <span><strong>Email:</strong> ${avaliacaoCompleta.emailResponsavel}</span>
                        </div>
                    `;

                    recalcularEExibirPontuacoes(); 
                    renderizarCardsDeResposta(); 
                    configurarBotaoFinal(); 
                    adicionarEventListeners(); 
                    configurarNavegacao(); 

                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    summaryContainer.innerHTML = `
                        <h1>Erro ao Carregar Relatório</h1>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" class="btn">Tentar Novamente</button>
                    `;
                }
            }

            carregarDados();

        });
    </script>
    <script src="/global.js"></script>
</body>
</html>