<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Avaliação - SIMPE | Governo de Pernambuco</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- VARIÁVEIS (Padrão Unificado) --- */
        :root {
            --azul-gov-principal: #002776;
            --azul-gov-escuro: #001a4d;
            --azul-gov-claro: #0052CC;
            --amarelo-gov-detalhe: #FFD700;
            --cinza-texto: #2c3e50;
            --cinza-claro: #7f8c8d;
            --cinza-fundo: #f8f9fa;
            --cinza-card: #ecf0f1;
            --branco: #ffffff;
            --verde-sucesso: #27ae60;
            --vermelho-erro: #dc3545;
            --laranja-alerta: #fd7e14;
            --sombra-suave: 0 2px 8px rgba(0, 0, 0, 0.08);
            --sombra-media: 0 4px 16px rgba(0, 0, 0, 0.12);
            --transicao-padrao: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif; 
            background-color: var(--cinza-fundo); 
            color: var(--cinza-texto); 
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER (Corrigido para garantir design do menu) --- */
        .main-header { 
            background-color: var(--branco); 
            box-shadow: var(--sombra-suave);
            padding: 0 5%; 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 3px solid var(--azul-gov-principal);
        }
        
        .main-nav { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 80px; 
        }

        .logo a { 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: var(--transicao-padrao);
        }

        .logo a:hover { transform: translateY(-2px); }

        .logo a > img { 
            height: 55px; 
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: var(--transicao-padrao);
        }

        .SIMPE-marca-text-group { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .SIMPE-marca-small { height: 55px !important; width: auto; object-fit: contain; }

        /* --- CORREÇÃO DO MENU (NAV-LINKS) --- */
        #nav-links { 
            list-style: none; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            gap: 8px; 
            align-items: center;
        }

        /* Garante que os LIs não atrapalhem o layout */
        #nav-links li {
            margin: 0;
            padding: 0;
            display: flex;
        }

        /* Estilos dos links (A) dentro do menu */
        #nav-links a { 
            text-decoration: none; 
            color: var(--cinza-texto); 
            font-weight: 600; 
            padding: 12px 20px; 
            border-radius: 8px; 
            transition: var(--transicao-padrao); 
            display: block; 
            font-size: 0.95em; 
            position: relative;
            cursor: pointer;
            white-space: nowrap;
        }

        #nav-links a::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 20px;
            right: 20px;
            height: 2px;
            background-color: var(--amarelo-gov-detalhe);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        #nav-links a:hover,
        #nav-links a.active { 
            color: var(--azul-gov-principal); 
            background-color: rgba(0, 39, 118, 0.05); 
        }

        #nav-links a:hover::after,
        #nav-links a.active::after {
            transform: scaleX(1);
        }
        
        /* --- MAIN CONTENT --- */
        main { padding: 40px 5%; flex-grow: 1; display: flex; justify-content: center; }
        
        .container { 
            width: 100%;
            max-width: 1000px; 
            background: var(--branco); 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: var(--sombra-media); 
            border-top: 5px solid var(--azul-gov-principal);
            position: relative;
        }

        /* --- RELATÓRIO --- */
        .report-container { 
            width: 100%;
            max-width: 1000px; 
            background: var(--branco); 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: var(--sombra-media); 
            border-top: 5px solid var(--azul-gov-principal);
            position: relative;
        }

        .report-header { 
            background: var(--branco); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: var(--sombra-suave); 
            margin-bottom: 30px; 
            border-left: 5px solid var(--azul-gov-principal);
        }

        .report-header h1 { 
            margin: 0 0 15px 0; 
            color: var(--azul-gov-principal); 
            font-size: 1.8em;
            font-weight: 700;
        }

        .report-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            font-size: 0.95em; 
            color: var(--cinza-texto); 
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .report-summary span { 
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .report-summary strong { 
            color: var(--azul-gov-principal);
        }
        
        /* --- SCORE CONTAINER --- */
        .score-container { 
            text-align: center; 
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-claro) 100%);
            color: var(--branco); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            display: flex;
            gap: 20px;
            position: sticky;
            top: 90px; /* Abaixo do header fixo */
            z-index: 900;
            box-shadow: var(--sombra-media);
        }

        .score-box { 
            flex: 1; 
            text-align: center; 
            border-right: 1px solid rgba(255, 255, 255, 0.3); 
            padding: 0 20px;
        }

        .score-box:last-child { 
            border-right: none; 
        }

        .score-box h2 { 
            margin: 0 0 5px 0; 
            text-transform: uppercase; 
            font-size: 0.85em; 
            font-weight: 600;
            opacity: 0.9; 
            letter-spacing: 0.5px;
        }

        .score-box .score-value { 
            font-size: 2em; 
            font-weight: 800; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- CARDS DE RESPOSTA --- */
        .resposta-card { 
            background-color: var(--branco); 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: var(--sombra-suave); 
            overflow: hidden; 
            border-left: 5px solid var(--cinza-claro);
            cursor: pointer;
            transition: var(--transicao-padrao);
            position: relative;
        }

        .resposta-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--sombra-media);
        }

        .card-mantido-sim { 
            border-left: 5px solid var(--verde-sucesso); 
            background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
        }

        .card-mantido-nao { 
            border-left: 5px solid var(--vermelho-erro); 
            background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
        }

        .card-alterado-rejeitado { 
            border-left: 5px solid var(--vermelho-erro);
            background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%);
        }

        .card-alterado-aprovado { 
            border-left: 5px solid var(--verde-sucesso);
            background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
        }

        .recurso-enviado { 
            border-left: 5px solid #6f42c1; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .resposta-header { 
            padding: 20px; 
            /*border-bottom: 1px solid #f0f0f0;*/
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }

        .resposta-body { padding: 20px; }

        .summary-header { 
            cursor: pointer; 
            font-weight: normal; 
            padding: 15px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-header strong { 
            font-weight: 700; 
            color: var(--cinza-texto);
            flex: 1;
        }

        .summary-status-badge { 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            font-weight: 700; 
            color: var(--branco); 
            display: inline-block;
            white-space: nowrap;
            box-shadow: var(--sombra-suave);
        }

        .summary-status-mantido { background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%); }
        .summary-status-nao-atende { background: linear-gradient(135deg, var(--vermelho-erro) 0%, #e74c3c 100%); }
        .summary-status-recurso { background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); }
        .summary-status-atende { background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%); }
        .summary-status-pendente { background: linear-gradient(135deg, var(--laranja-alerta) 0%, #f39c12 100%); color: var(--cinza-texto); }
        .summary-status-divergencia { background: linear-gradient(135deg, var(--amarelo-gov-detalhe) 0%, #f1c40f 100%); color: var(--cinza-texto); }

        /* --- RECURSO STYLES --- */
        .recurso-info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #6f42c1;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--sombra-suave);
        }
        
        .prazo-alerta {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid var(--amarelo-gov-detalhe);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: var(--sombra-suave);
        }
        
        .prazo-expirado {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid var(--vermelho-erro);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: var(--sombra-suave);
        }
        
        .prazo-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border: 2px solid var(--azul-gov-claro);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--sombra-suave);
            text-align: center;
        }

        .recurso-info-card h4 {
            color: #6f42c1;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recurso-decisao {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
            margin: 5px 0;
            box-shadow: var(--sombra-suave);
        }
        
        .decisao-atende {
            background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%);
            color: var(--branco);
        }
        
        .decisao-nao-atende {
            background: linear-gradient(135deg, var(--vermelho-erro) 0%, #e74c3c 100%);
            color: var(--branco);
        }

        .recurso-box { 
            margin-top: 20px; 
            padding: 25px; 
            border: 2px solid var(--amarelo-gov-detalhe); 
            background: linear-gradient(135deg, #fffaf0 0%, #fff5e6 100%);
            border-radius: 12px; 
            box-shadow: var(--sombra-suave);
        }

        .recurso-box h4 { 
            margin-top: 0; 
            margin-bottom: 15px; 
            color: var(--azul-gov-principal); 
            font-size: 1.3em;
        }

        .recurso-box > p { 
            font-size: 0.95em; 
            margin-top: 0; 
            margin-bottom: 20px; 
            color: var(--cinza-texto); 
            line-height: 1.5;
        }

        /* --- BOTÕES --- */
        .btn { 
            padding: 12px 24px; 
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-claro) 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 700; 
            transition: var(--transicao-padrao); 
            box-shadow: var(--sombra-suave);
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--sombra-media); 
        }
        
        .btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%);
        }

        .btn-toggle { 
            padding: 10px 20px; 
            border: 2px solid #e1e5e9; 
            background-color: var(--branco); 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transicao-padrao);
            min-width: 120px;
            text-align: center;
        }
        
        .btn-toggle:hover { 
            background-color: #f8f9fa; 
            transform: translateY(-1px);
            box-shadow: var(--sombra-suave);
        }
        
        .btn-toggle.active { 
            background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%);
            color: var(--branco); 
            border-color: var(--verde-sucesso); 
            box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
        }
        
        .btn-toggle[data-action*="nao"].active { 
            background: linear-gradient(135deg, var(--vermelho-erro) 0%, #e74c3c 100%);
            border-color: var(--vermelho-erro); 
            color: var(--branco); 
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        }

        .btn-toggle:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-editar-decisao {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--amarelo-gov-detalhe) 0%, #e6c200 100%);
            color: var(--cinza-texto);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: var(--transicao-padrao);
            margin-top: 15px;
            box-shadow: var(--sombra-suave);
        }
        
        .btn-editar-decisao:hover {
            background: linear-gradient(135deg, #e6c200 0%, #ccaa00 100%);
            transform: translateY(-2px);
            box-shadow: var(--sombra-media);
        }

        .btn-add-evidence { 
            padding: 8px 16px; 
            font-size: 0.85em; 
            border-radius: 6px; 
            border: 1px dashed var(--azul-gov-principal); 
            background-color: rgba(0, 39, 118, 0.05); 
            color: var(--azul-gov-principal); 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .btn-add-evidence:hover { 
            background-color: rgba(0, 39, 118, 0.1); 
            border-style: solid;
            transform: translateY(-1px);
        }

        /* --- EVIDÊNCIAS E COMENTÁRIOS --- */
        .evidence-container { 
            margin-bottom: 15px; 
            padding-top: 15px; 
            border-top: 1px solid #f0f0f0; 
        }
        
        .evidence-list { 
            list-style: none; 
            padding-left: 0; 
            margin: 0 0 15px 0; 
        }
        
        .evidence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            border: 1px solid #e1e5e9;
            transition: var(--transicao-padrao);
        }
        
        .evidence-item:hover {
            background-color: #e9ecef;
        }
        
        .evidence-item a { 
            color: var(--azul-gov-principal); 
            font-weight: 600;
            text-decoration: none;
            word-break: break-all;
        }
        
        .evidence-item a:hover { 
            text-decoration: underline; 
        }

        .remove-evidence-btn {
            background: none;
            border: none;
            color: var(--cinza-claro);
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.2s;
            padding: 0 5px;
        }
        
        .remove-evidence-btn:hover { 
            color: var(--vermelho-erro); 
        }

        .add-evidence-buttons { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
        }

        .link-comprovante-wrapper { 
            display: none; 
            width: 100%; 
            margin-top: 15px; 
        }

        .link-comprovante-wrapper.show { 
            display: block; 
        }

        .recurso-comment {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            min-height: 80px;
            resize: none;
            margin-top: 15px;
            transition: var(--transicao-padrao);
            background-color: #fcfcfc;
        }

        .recurso-comment:focus {
            border-color: var(--azul-gov-principal);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
            background-color: var(--branco);
        }

        /* --- ANÁLISE SCGE --- */
        .analise-scge-destaque {
            background: linear-gradient(135deg, #e9eef5 0%, #f8f9fa 100%);
            border: 2px solid var(--azul-gov-principal);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: var(--sombra-suave);
        }

        .analise-scge-destaque h5 {
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-escuro) 100%) !important;
            color: var(--branco) !important;
            padding: 15px 20px !important;
            margin: -25px -27px 20px -27px !important;
            border-radius: 10px 10px 0 0;
            font-size: 1em !important;
            font-weight: 700 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comentario-analista-destaque {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--amarelo-gov-detalhe) !important;
            font-style: normal !important;
        }

        .comentario-analista-destaque strong {
            margin: 0 0 10px 0 !important;
            font-size: 0.95em !important;
            color: var(--cinza-texto) !important; 
            font-weight: 600 !important;
            background: none !important;
            padding: 0 !important;
            text-align: left !important;
            width: 100% !important;
            display: block !important;
        }

        .comentario-analista-destaque p {
            margin: 0;
            color: #555 !important;
            font-weight: 500;
            line-height: 1.4;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            overflow-wrap: break-word !important;
        }

        .link-analista-container {
            margin-top: 20px !important;
            margin-bottom: 15px;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            border-left: 3px solid var(--azul-gov-principal);
        }

        .link-analista-container h5 {
            margin: 0 0 8px 0 !important;
            font-size: 0.9em !important;
            color: var(--cinza-texto) !important;
            font-weight: 600 !important;
            background: none !important;
            padding: 0 !important;
            text-align: left !important;
            display: block !important;
            text-transform: none !important;
        }

        .link-analista-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: var(--branco);
        }

        .link-analista-display .evidence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        .link-analista-display .evidence-item:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .link-analista-display .evidence-item a {
            flex: 1;
            word-break: break-all;
            margin-right: 10px;
            color: var(--azul-gov-claro);
            text-decoration: none;
            font-size: 0.85em;
        }

        .link-analista-display .evidence-item a:hover {
            text-decoration: underline;
            color: var(--azul-gov-principal);
        }

        .status-validacao { 
            font-weight: 700; 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 0.85em; 
            text-transform: uppercase; 
            color: var(--branco); 
            display: inline-block;
        }

        .status-aprovado { background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%); }
        .status-rejeitado { background: linear-gradient(135deg, var(--vermelho-erro) 0%, #e74c3c 100%); }
        .status-pendente { background: linear-gradient(135deg, var(--laranja-alerta) 0%, #f39c12 100%); color: var(--cinza-texto); }

        /* --- ALERTAS --- */
        .recurso-alerta {
            background: linear-gradient(135deg, #fffaf0 0%, #fff5e6 100%);
            border: 2px solid var(--amarelo-gov-detalhe);
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            color: #856404;
            margin: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transicao-padrao);
            box-shadow: var(--sombra-suave);
        }

        .recurso-alerta:hover {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffb507;
            transform: translateY(-2px);
            box-shadow: var(--sombra-media);
        }

        .recurso-alerta[style*="background-color: #f0fff4"] {
            background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%) !important;
            border: 2px solid var(--verde-sucesso) !important;
            color: #2d5016 !important;
            box-shadow: var(--sombra-suave) !important;
        }

        .recurso-alerta[style*="background-color: #f0fff4"]:hover {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%) !important;
            border-color: #218838 !important;
            transform: translateY(-2px);
            box-shadow: var(--sombra-media) !important;
        }

        /* --- MODAL --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
        }

        .modal-content { 
            background: var(--branco); 
            padding: 30px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative; 
            box-shadow: var(--sombra-media);
            border-top: 5px solid var(--azul-gov-principal);
        }

        .modal-close-btn { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            background: none; 
            border: none; 
            font-size: 2.5em; 
            line-height: 1; 
            color: var(--cinza-claro); 
            cursor: pointer; 
            transition: var(--transicao-padrao);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close-btn:hover { 
            color: var(--vermelho-erro); 
            background-color: rgba(220, 53, 69, 0.1);
            transform: scale(1.1);
        }

        /* --- INFO BLOCKS --- */
        .info-block { 
            border-top: 1px solid #eee; 
            padding-top: 20px; 
            margin-top: 20px; 
        }

        .info-block:first-child { 
            border-top: none; 
            padding-top: 0; 
            margin-top: 0; 
        }

        .info-block h4, .info-block h5, .info-block h6 { 
            margin: 0 0 15px 0; 
            background: linear-gradient(135deg, #e9eef5 0%, #f8f9fa 100%);
            padding: 12px 16px; 
            border-radius: 8px; 
            font-size: 1.1em; 
            color: var(--azul-gov-principal); 
            font-weight: 700; 
            border-left: 4px solid var(--amarelo-gov-detalhe);
        }

        .atende-badge { 
            font-weight: 700; 
            padding: 8px 16px; 
            border-radius: 20px; 
            color: var(--branco); 
            font-size: 0.9em; 
            display: inline-block;
            box-shadow: var(--sombra-suave);
        }

        .atende-sim { background: linear-gradient(135deg, var(--verde-sucesso) 0%, #2ecc71 100%); }
        .atende-nao { background: linear-gradient(135deg, var(--vermelho-erro) 0%, #e74c3c 100%); }

        /* --- FOOTER (Padrão Unificado) --- */
        .main-footer { 
            text-align: center; 
            padding: 30px 5%; 
            margin-top: auto;
            background: linear-gradient(135deg, var(--azul-gov-principal) 0%, var(--azul-gov-escuro) 100%);
            color: var(--branco);
            font-size: 0.95em; 
            position: relative; 
            min-height: 80px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        .main-footer .footer-content { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            max-width: 1400px;
            margin: 0 auto;
            height: 100%; 
            position: relative;
        }

        .main-footer .footer-portal-link {
            position: absolute;
            left: 0.5%;
            top: 50%;
            transform: translateY(-50%);
            display: block;
            z-index: 10;
            height: 70px;
            width: auto;
            transition: var(--transicao-padrao);
        }

        .main-footer .footer-portal-link:hover { transform: translateY(-50%) scale(1.05); }

        .main-footer .footer-portal-link img {
            height: 100%;
            width: auto;
            display: block;
            max-height: 70px;
            mix-blend-mode: lighten;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .main-footer .footer-logo-link {
            position: absolute; 
            right: 0.5%; 
            top: 50%; 
            transform: translateY(-50%);
            display: block; 
            height: 70px; 
            width: auto; 
            transition: var(--transicao-padrao);
        }

        .main-footer .footer-logo-link:hover { transform: translateY(-50%) scale(1.05); }

        .main-footer .footer-logo-link img { 
            height: 100%; 
            width: auto; 
            display: block; 
            max-height: 70px; 
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .main-footer p { color: rgba(255, 255, 255, 0.9); font-weight: 400; margin: 0; }
        .main-footer p a { color: var(--amarelo-gov-detalhe); font-weight: 600; text-decoration: none; padding: 4px 8px; border-radius: 4px; }
        .main-footer p a:hover { background-color: rgba(255, 215, 0, 0.2); text-decoration: underline; }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .main-nav { flex-direction: column; height: auto; padding: 20px 0; }
            .main-nav ul { flex-direction: column; width: 100%; margin-top: 15px; }
            .report-container { padding: 25px; }
            .score-container { flex-direction: column; gap: 15px; }
            .score-box { border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding: 15px 0; }
            .score-box:last-child { border-bottom: none; }
            .report-summary { grid-template-columns: 1fr; }
            .resposta-header-content { flex-direction: column; align-items: flex-start; gap: 10px; }
            
            .main-footer .footer-content { flex-direction: column; gap: 15px; }
            .main-footer .footer-portal-link, .main-footer .footer-logo-link { position: static; transform: none; height: 50px; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="main-nav">
            <div class="logo">
                <a href="/">
                    <img src="/assets/logo-header.png" alt="Logo Governo de Pernambuco">
                    <div class="SIMPE-marca-text-group">                      
                        <img src="/assets/simpe.png" alt="Logo SIMPE" class="SIMPE-marca-small">                      
                    </div>
                </a>
            </div>
            <ul id="nav-links"></ul>
        </nav>
    </header>

    <main>
        <div class="report-container">
            <div id="summary-container" class="report-header"><p>Carregando dados...</p></div>
            <div id="score-wrapper">
                <div class="score-container">
                    <div class="score-box">
                        <h2>Sua Nota (Autoavaliação)</h2>
                        <div id="score-secretaria" class="score-value">-- / --</div>
                    </div>
                    <div class="score-box">
                        <h2>Nota Validada (SCGE)</h2>
                        <div id="score-admin" class="score-value">-- / --</div>
                    </div>
                </div>
            </div>
            <div id="prazo-container"></div>
            <div id="respostas-container"></div>
            <div id="recurso-actions-container" style="text-align: right; margin-top: 30px;"></div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <a href="https://transparencia.pe.gov.br/" target="_blank" rel="noopener noreferrer" class="footer-portal-link">
                <img src="/assets/image-portal.png" alt="Portal da Transparência">
            </a>

            <p>&copy; 2025 Governo de Pernambuco. Todos os direitos reservados. <a id="admin-footer-link" href="/admin" style="display: none;">Área Administrativa</a></p>
            
            <a href="https://www.scge.pe.gov.br/" target="_blank" rel="noopener noreferrer" class="footer-logo-link">
                <img src="/assets/logo-footer.png" alt="Logo da Controladoria-Geral do Estado de Pernambuco">
            </a>
        </div>
    </footer>

    <div id="modal-overlay" class="modal-overlay" style="display: none;" aria-hidden="true">
        <div id="modal-content" class="modal-content" tabindex="-1">
            <button id="modal-close-btn" class="modal-close-btn" aria-label="Fechar modal">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const avaliacaoId = window.location.pathname.split('/').pop();
            const summaryContainer = document.getElementById('summary-container');
            const prazoContainer = document.getElementById('prazo-container');
            const scoreSecretariaEl = document.getElementById('score-secretaria');
            const scoreAdminEl = document.getElementById('score-admin');            
            const respostasContainer = document.getElementById('respostas-container');
            const recursoActionsContainer = document.getElementById('recurso-actions-container');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const authToken = localStorage.getItem('authToken');
            
            let avaliacaoCompleta = null;
            let currentModalRespostaId = null;
            let prazoExpirado = false;
            let prazoInfo = null;
            let warned10min = false;
            let warned5min = false;
            let warned1min = false;

            console.log('=== INICIANDO APLICAÇÃO ===');

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };

            function adicionarListenersAoBox(boxElement) {
                const debouncedSalvarRascunho = debounce(salvarRascunhoRecurso, 750);

                boxElement.querySelectorAll('.btn-toggle').forEach(botao => {
                    botao.addEventListener('click', function() {
                        const action = this.dataset.action;
                        const grupoBotoes = this.closest('.requisito-actions').querySelectorAll('.btn-toggle');
                        grupoBotoes.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        const evidenceWrapper = this.closest('.recurso-box').querySelector('.link-comprovante-wrapper');
                        if (evidenceWrapper) {
                            if (action.includes('sim-')) {
                                evidenceWrapper.classList.add('show');
                            } else {
                                evidenceWrapper.classList.remove('show');
                            }
                        }
                        salvarRascunhoRecurso();
                    });
                });

                boxElement.querySelectorAll('.add-link-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const evidenceList = this.closest('.evidence-container').querySelector('.evidence-list');
                        Swal.fire({
                            title: 'Adicionar Nova Evidência',
                            input: 'text',
                            inputLabel: 'URL do Link de Comprovação',
                            inputPlaceholder: 'exemplo.com.br ou https://exemplo.com.br',
                            confirmButtonText: 'Adicionar',
                            confirmButtonColor: 'var(--azul-gov-principal)',
                            showCancelButton: true,
                            cancelButtonText: 'Cancelar',
                            cancelButtonColor: 'var(--vermelho-erro)',
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Você precisa digitar um endereço web!';
                                }
                                if (/\s/.test(value)) { 
                                    return 'O endereço não pode conter espaços.';
                                }
                                if (value.length > 0 && !value.includes('.')) { 
                                    return 'Insira um endereço válido (ex: exemplo.com)';
                                }
                                return null; 
                            },
                            preConfirm: (value) => {
                                let finalUrl = value.trim();
                                
                                finalUrl = finalUrl.replace(/^(https?:\/\/|\/\/)/i, '');
                                
                                if (!/^(https?:\/\/)/i.test(finalUrl)) {
                                    finalUrl = 'https://' + finalUrl;
                                }
                                
                                return finalUrl;
                            }
                        }).then((result) => {
                            if (result.isConfirmed && result.value) {
                                const url = result.value;
                                const newItem = document.createElement('li');
                                newItem.className = 'evidence-item';
                                newItem.dataset.link = url;
                                newItem.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url}</a><button class="remove-evidence-btn" title="Remover Evidência">&times;</button>`;
                                evidenceList.appendChild(newItem);

                                const removeBtn = newItem.querySelector('.remove-evidence-btn');
                                removeBtn.addEventListener('click', function() {
                                    this.closest('.evidence-item').remove();
                                    salvarRascunhoRecurso();
                                });

                                salvarRascunhoRecurso();
                            }
                        });
                    });
                });

                boxElement.querySelectorAll('.remove-evidence-btn').forEach(btn => {
                    const listenerAttached = btn.getAttribute('data-listener-attached');
                    if (!listenerAttached) {
                        btn.addEventListener('click', function() {
                            this.closest('.evidence-item').remove();
                            salvarRascunhoRecurso();
                        });
                        btn.setAttribute('data-listener-attached', 'true');
                    }
                });

                const comentarioEl = boxElement.querySelector('.recurso-comment');
                if (comentarioEl) {
                    comentarioEl.addEventListener('input', debouncedSalvarRascunho);
                    comentarioEl.addEventListener('blur', salvarRascunhoRecurso);
                }
            }

            function aplicarEstadoRascunhoAoBox(boxElement, dadosRascunho) {
                 const comentarioEl = boxElement.querySelector('.recurso-comment');
                 if (comentarioEl && dadosRascunho?.comentario !== undefined) {
                     comentarioEl.value = dadosRascunho.comentario;
                 }

                 const botaoSim = boxElement.querySelector('[data-action="sim-recurso"]');
                 const botaoNao = boxElement.querySelector('[data-action="nao-recurso"]');
                 const evidenceWrapper = boxElement.querySelector('.link-comprovante-wrapper');

                 if (botaoSim && botaoNao) {
                     botaoSim.classList.remove('active');
                     botaoNao.classList.remove('active');
                     if (dadosRascunho?.sim === true) {
                         botaoSim.classList.add('active');
                         if (evidenceWrapper) evidenceWrapper.classList.add('show');
                     } else {
                         botaoNao.classList.add('active');
                         if (evidenceWrapper) evidenceWrapper.classList.remove('show');
                     }
                 }

                 const evidenceList = boxElement.querySelector('.evidence-list-recurso');
                 if (evidenceList && Array.isArray(dadosRascunho?.evidencias)) {
                     evidenceList.innerHTML = '';
                     dadosRascunho.evidencias.forEach(url => {
                         const newItem = document.createElement('li');
                         newItem.className = 'evidence-item';
                         newItem.dataset.link = url;
                         newItem.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url}</a><button class="remove-evidence-btn" title="Remover Evidência">&times;</button>`;
                         evidenceList.appendChild(newItem);
                     });
                 } else if (evidenceList) {
                      evidenceList.innerHTML = '';
                 }
            }

            async function verificarPrazoRecurso() {
                try {
                    const response = await fetch(`/api/avaliacoes/${avaliacaoId}/verificar-prazo-recurso`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (response.ok) {
                        const prazoData = await response.json();
                        console.log('Dados do prazo recebidos:', prazoData);
                        
                        prazoInfo = prazoData;
                        
                        if ((!prazoData.dentroDoPrazo || prazoData.recursoExpirado) && 
                            avaliacaoCompleta.status === 'AGUARDANDO_RECURSO') {
                            prazoExpirado = true;
                            return false;
                        } else if (prazoData.dentroDoPrazo && avaliacaoCompleta.status === 'AGUARDANDO_RECURSO') {
                            prazoExpirado = false;
                            return true;
                        }
                    }
                    return true; 
                } catch (error) {
                    console.error('Erro ao verificar prazo:', error);
                    return true;
                }
            }

            function exibirInformacoesPrazo() {
                if (avaliacaoCompleta.status === 'AGUARDANDO_RECURSO') {
                    if (prazoExpirado) {
                        prazoContainer.innerHTML = `
                            <div class="prazo-expirado">
                                <h4>Prazo de Recurso Expirado</h4>
                                <p>O prazo para envio de recurso expirou em <strong>${new Date(prazoInfo.dataLimite).toLocaleString('pt-BR')}</strong>.</p>
                                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #721c24;">
                                    Não é mais possível enviar recursos para esta avaliação. A SCGE procederá com a análise final.
                                </p>
                            </div>
                        `;
                    } else if (prazoInfo && prazoInfo.dentroDoPrazo) {
                        let totalSegundos = prazoInfo.segundosRestantes;

                        const dias = Math.floor(totalSegundos / 86400); 
                        totalSegundos %= 86400; 
                        const horas = Math.floor(totalSegundos / 3600); 
                        totalSegundos %= 3600; 
                        const minutos = Math.floor(totalSegundos / 60); 
                        const segundos = totalSegundos % 60; 

                        let tempoFormatado = "";
                        if (dias > 0) {
                            tempoFormatado += `${dias} ${dias > 1 ? 'dias' : 'dia'} e `;
                        }
                        tempoFormatado += `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;

                        prazoContainer.innerHTML = `
                            <div class="prazo-info">
                                <h4 style="font-size: 1.2em; margin-top: 0; margin-bottom: 10px;">Prazo para Recurso</h4>
                                <p style="margin-top: 0; margin-bottom: 10px;"><strong>${tempoFormatado}</strong> restantes para enviar o recurso.</p>
                                <p style="margin: 0; font-size: 1.05em; color: #0c5460; font-weight: 500;">
                                    Data limite: <strong>${new Date(prazoInfo.dataLimite).toLocaleString('pt-BR')}</strong>
                                </p>
                            </div>
                        `;
                    } else {
                        prazoContainer.innerHTML = `
                            <div class="prazo-alerta">
                                <h4>⚠️ Prazo de Recurso</h4>
                                <p>Verificando informações do prazo...</p>
                            </div>
                        `;
                    }
                } else {
                    prazoContainer.innerHTML = '';
                }
            }

            function inicializarBotoesRecursoAutomatico() {
                document.querySelectorAll('.recurso-box[data-is-editable="true"]').forEach(recursoBox => {
                    const initialized = recursoBox.getAttribute('data-listeners-initialized');
                    if (!initialized) {
                        adicionarListenersAoBox(recursoBox);
                        recursoBox.setAttribute('data-listeners-initialized', 'true');
                    }
                });
            }

            function salvarRascunhoRecurso() {
                console.log('=== SALVANDO RASCUNHO SIMPLIFICADO ===');
                
                const rascunhoRecurso = {};
                let temDados = false;

                document.querySelectorAll('.recurso-box[data-is-editable="true"]').forEach(box => {
                    const respostaCard = box.closest('.resposta-card');
                    const respostaId = parseInt(respostaCard.dataset.respostaId);

                    console.log(`Salvando resposta ${respostaId}`);

                    const evidencias = [];
                    box.querySelectorAll('.evidence-item').forEach(item => {
                        if (item.dataset.link) {
                            evidencias.push(item.dataset.link);
                        }
                    });

                    const data = {
                        comentario: box.querySelector('.recurso-comment')?.value || '',
                        evidencias: evidencias,
                        sim: box.querySelector('[data-action="sim-recurso"]')?.classList.contains('active') || false,
                        timestamp: new Date().toISOString() 
                    };
                    
                    rascunhoRecurso[respostaId] = data;
                    temDados = true;
                });

                if (temDados) {
                    localStorage.setItem(`rascunho_recurso_${avaliacaoId}`, JSON.stringify(rascunhoRecurso));
                    console.log("Rascunho do recurso salvo com sucesso:", rascunhoRecurso);

                    Swal.fire({
                        title: 'Salvo!',
                        text: 'Rascunho salvo com sucesso.',
                        icon: 'success',
                        timer: 2000, 
                        showConfirmButton: false,
                        toast: true, 
                        position: 'top-end'
                    });
                } else {
                    console.log("Nenhum dado para salvar");
                }
            }

            function carregarRascunhoRecurso() {
                const rascunhoSalvo = localStorage.getItem(`rascunho_recurso_${avaliacaoId}`);
                const rascunhoGeral = rascunhoSalvo ? JSON.parse(rascunhoSalvo) : {};
                let algumRascunhoCarregado = false;

                document.querySelectorAll('.recurso-box[data-is-editable="true"]').forEach(box => {
                    const respostaCard = box.closest('.resposta-card');
                    if (!respostaCard) return;
                    const respostaId = respostaCard.dataset.respostaId;
                    const dadosRascunho = rascunhoGeral[respostaId];

                    aplicarEstadoRascunhoAoBox(box, dadosRascunho);
                    if (dadosRascunho) {
                        algumRascunhoCarregado = true;
                    }
                });

                if (algumRascunhoCarregado) {
                console.log("Rascunho de recurso carregado.");
                } else if (rascunhoSalvo) { 
                    console.log("Rascunho antigo encontrado, mas não aplicável aos itens atuais.");
                } else {
                    console.log("Nenhum rascunho encontrado.");
                }


                setTimeout(inicializarBotoesRecursoAutomatico, 50);
            }

            function abrirModal(resposta) {
                console.log("=== ABRINDO MODAL SIMPLIFICADO ===");
                console.log("Resposta ID:", resposta.id);
                console.log("Requisito:", resposta.requisito.texto);
                
                currentModalRespostaId = resposta.id;
                const isRecursoPhase = avaliacaoCompleta.status === 'AGUARDANDO_RECURSO';

                console.log("Status da avaliação:", avaliacaoCompleta.status);
                console.log("É fase de recurso?", isRecursoPhase);

                const atendeClasse = resposta.atende ? 'atende-sim' : 'atende-nao';
                const atendeTexto = resposta.atende ? 'Atende' : 'Não atende';
                const answerHTML = `<p><strong>Resposta:</strong> <span class="atende-badge ${atendeClasse}">${atendeTexto}</span></p>`;
                
                let evidencesHTML = '';
                const evidencias = Array.isArray(resposta.evidencias) ? resposta.evidencias : [];
                
                const linkComprovante = isRecursoPhase ? resposta.linkComprovanteRecurso : resposta.linkComprovante;
                
                if (evidencias.length > 0 || linkComprovante) {
                    evidencesHTML += `<div class="evidence-section"><h5>Evidências Fornecidas:</h5><ul class="evidence-list">`;
                    if (linkComprovante) {
                        const labelComprovante = isRecursoPhase ? ' (Comprovante do Recurso)' : ' (Automático)';
                        evidencesHTML += `<li class="evidence-item"><a href="${linkComprovante}" target="_blank">${linkComprovante}</a>${labelComprovante}</li>`;
                    }
                    evidencias.forEach(ev => { 
                        evidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`; 
                    });
                    evidencesHTML += `</ul></div>`;
                }

                let commentHTML = '';
                if (resposta.comentarioSecretaria) {
                    commentHTML = `<div class="comment-section"><h5>Seu Comentário Original:</h5><p>"${resposta.comentarioSecretaria}"</p></div>`;
                }
                
                let adminFeedbackHTML = '';
                const mostrarAnaliseSCGE = avaliacaoCompleta.status === 'FINALIZADA' || 
                                        avaliacaoCompleta.status === 'AGUARDANDO_RECURSO' ||
                                        avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO';

                if (mostrarAnaliseSCGE) {
                    const houveDivergencia = (resposta.atende !== (resposta.statusValidacao === 'aprovado'));
                    let statusTexto;
                    let statusClass;
                    
                    if (avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO') {
                        statusTexto = 'Em Análise'; 
                        statusClass = 'status-pendente';
                    } else {
                        statusTexto = !resposta.statusValidacao || resposta.statusValidacao === 'pendente' ? 'Pendente' : (houveDivergencia ? 'Alterado' : 'Mantido');
                        statusClass = `status-${resposta.statusValidacao || 'pendente'}`;
                    }
                    
                    let linksAnalistaHTML = '';
                    if (resposta.linksAnalista && resposta.linksAnalista.length > 0) {
                        linksAnalistaHTML = `
                            <div class="link-analista-container">
                                <h5>Links de Referência do Analista</h5>
                                <div class="link-analista-display">
                                    ${resposta.linksAnalista.map(link => `
                                        <div class="evidence-item">
                                            <a href="${link.url}" target="_blank" title="Abrir link em nova aba">${link.url}</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>`;
                    }
                    
                    adminFeedbackHTML = `
                        <div class="info-block analise-scge-destaque">
                            <h5>Análise da SCGE</h5>
                            
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <strong style="font-size: 0.9em;">Resultado:</strong>
                                <span class="status-validacao ${statusClass}" style="font-size: 0.8em; padding: 4px 8px;">${statusTexto}</span>
                            </div>
                            
                            ${linksAnalistaHTML}
                            
                            ${resposta.comentarioAdmin ? `
                                <div class="comentario-analista-destaque">
                                    <strong>Comentário do Analista:</strong>
                                    <p style="color: #666666 !important; margin: 0 !important;">"${resposta.comentarioAdmin}"</p>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px; margin-top: 10px;">
                                    <p style="margin: 0; color: #6c757d; font-style: italic;">
                                        Nenhum comentário adicional do analista.
                                    </p>
                                </div>
                            `}
                        </div>`;
                } else if (avaliacaoCompleta.status === 'EM_ANALISE_SCGE') {
                    adminFeedbackHTML = `
                        <div class="info-block analise-scge-destaque">
                            <h5>Análise da SCGE</h5>
                            <div style="text-align: center; padding: 20px;">
                                <span class="status-validacao status-pendente" style="display: inline-block; margin-bottom: 10px;">Em Análise</span>
                                <p style="margin: 0; color: #6c757d; font-style: italic;">
                                    Esta avaliação está sendo analisada pela Controladoria Geral do Estado.
                                </p>
                            </div>
                        </div>`;
                }

                let recursoInfoHTML = '';
                if (resposta.recursoEnviado) {
                    const atendeRecurso = resposta.atendeRecurso !== undefined ? resposta.atendeRecurso : resposta.atende;
                    
                    recursoInfoHTML = `
                        <div class="recurso-info-card">
                            <h4>Recurso Enviado</h4>
                            <p><strong>Sua Decisão no Recurso:</strong> <span class="recurso-decisao ${atendeRecurso ? 'decisao-atende' : 'decisao-nao-atende'}">${atendeRecurso ? 'Atende' : 'Não atende'}</span></p>
                            ${resposta.comentarioRecurso ? `
                                <div class="info-block">
                                    <h5>Seu Comentário no Recurso</h5>
                                    <p>"${resposta.comentarioRecurso}"</p>
                                </div>
                            ` : ''}
                        </div>`;
                }

                let recursoEvidencesHTML = '';
                const evidenciasRecurso = Array.isArray(resposta.evidencias) ? 
                    resposta.evidencias.filter(ev => ev.tipo === 'recurso') : [];
                if (evidenciasRecurso.length > 0) {
                    recursoEvidencesHTML = `<div class="evidence-section"><h5>Evidências do Recurso:</h5><ul class="evidence-list">`;
                    evidenciasRecurso.forEach(ev => { 
                        recursoEvidencesHTML += `<li class="evidence-item"><a href="${ev.url}" target="_blank">${ev.url}</a></li>`; 
                    });
                    recursoEvidencesHTML += `</ul></div>`;
                }

                let editarDecisaoHTML = '';
                const usuarioMarcouNaoAtende = !resposta.atende;
                const scgeConfirmouNaoAtende = resposta.statusValidacao === 'rejeitado';

                if (usuarioMarcouNaoAtende && scgeConfirmouNaoAtende && isRecursoPhase && !resposta.recursoEnviado) {
                    editarDecisaoHTML = `
                        <div class="info-block" style="margin-top: 20px;">
                            <button class="btn-editar-decisao" data-resposta-id="${resposta.id}">
                                Editar Decisão
                            </button>
                        </div>`;
                }

                modalBody.innerHTML = `
                    <div class="info-block">
                        <h4>${resposta.requisito.texto}</h4>
                        ${answerHTML}
                        ${commentHTML} 
                        ${evidencesHTML}
                    </div>
                    ${adminFeedbackHTML}
                    ${recursoInfoHTML}
                    ${recursoEvidencesHTML}
                    ${editarDecisaoHTML}
                `;
                
                modalOverlay.style.display = 'flex';
                setTimeout(() => {
                    modalContent.focus();
                }, 100);
            }

            function fecharModal() {
                modalOverlay.style.display = 'none';
                currentModalRespostaId = null;
            }

            function criarRecursoHTML(container, resposta, isRecursoPhase, showRecurso, recursoEnviado) {
                console.log('=== CRIANDO HTML DO RECURSO SIMPLIFICADO ===');
                
                let recursoHTML = '';

                if (showRecurso && isRecursoPhase && !recursoEnviado) {
                    const foiRejeitado = resposta.statusValidacao === 'rejeitado';
                    const foiAprovado = resposta.statusValidacao === 'aprovado';

                    console.log(`Requisito normal - Status: ${resposta.statusValidacao}`);

                    if (foiRejeitado) {
                        recursoHTML = `
                            <div class="recurso-box" data-is-editable="true">
                                <h4>Área de Recurso</h4>
                                <p>Você pode alterar sua decisão para este requisito abaixo:</p>
                                <div class="requisito-actions">
                                    <span>Sua nova resposta:</span>
                                    <button class="btn-toggle" data-action="sim-recurso" title="Ao clicar em atende você afirma que a secretaria atende ao requisito">Atende</button>
                                    <button class="btn-toggle active" data-action="nao-recurso" title="Ao clicar em não atende afirma que a secretaria não atende ao requisito">Não atende</button>
                                </div>
                                <div class="link-comprovante-wrapper">
                                    <div class="evidence-container">
                                        <ul class="evidence-list-recurso evidence-list"></ul>
                                        <div class="add-evidence-buttons">
                                            <button class="btn-add-evidence add-link-btn" title="Adicionar nova evidência para comprovar o atendimento ao requisito">+ Adicionar Link</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-container">
                                    <textarea class="recurso-comment" placeholder="Adicionar justificativa para a alteração (opcional)..."></textarea>
                                </div>
                            </div>`;
                    } else if (foiAprovado) {
                        recursoHTML = `
                            <div class="recurso-box" data-is-editable="false">
                                <h4>Análise da SCGE</h4>
                                <div class="validacao-scge-completa">
                                    <p>✅ Este requisito foi validado como "Atende" pela Controladoria Geral do Estado.</p>
                                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                        Não é necessário enviar recurso para este requisito.
                                    </p>
                                </div>
                            </div>`;
                    }
                    
                    container.innerHTML = recursoHTML;
                }
            }

            function calcularPontuacaoRecurso() {
                console.log('=== CALCULANDO PONTUAÇÃO COM AUTOAVALIAÇÃO ORIGINAL ===');

                let pontuacaoSecretariaOriginal = 0; 
                let pontuacaoAdmin = 0;
                let pontuacaoTotal = 0;

                if (!avaliacaoCompleta || !Array.isArray(avaliacaoCompleta.respostas)) {
                    return { pontuacaoSecretaria: 0, pontuacaoAdmin: 0, pontuacaoTotal: 0 }; 
                }

                avaliacaoCompleta.respostas.forEach(resposta => {
                    const pontuacaoRequisito = resposta.requisito?.pontuacao || 0;
                    pontuacaoTotal += pontuacaoRequisito;

                    if (resposta.atendeOriginal === true) { 
                        pontuacaoSecretariaOriginal += pontuacaoRequisito;
                    }

                    if (resposta.statusValidacao === 'aprovado') {
                        pontuacaoAdmin += pontuacaoRequisito;
                    }
                });

                console.log('Pontuação recurso - Autoavaliação Original:', pontuacaoSecretariaOriginal, 'Admin:', pontuacaoAdmin, 'Total:', pontuacaoTotal);
                return { pontuacaoSecretaria: Math.round(pontuacaoSecretariaOriginal), pontuacaoAdmin: Math.round(pontuacaoAdmin), pontuacaoTotal };
            }

            function gerarCSVRecurso() {
                if (!avaliacaoCompleta || !Array.isArray(avaliacaoCompleta.respostas)) {
                    console.error("Dados da avaliação inválidos para gerar CSV.");
                    Swal.fire('Erro', 'Não foi possível gerar o CSV. Dados da avaliação ausentes.', 'error');
                    return;
                }

                console.log("Iniciando geração do CSV para recurso...");

                const headers = [
                    "Requisito",
                    "Pontuacao",
                    "Sua Resposta Original", 
                    "Seu Comentario Original",
                    "Suas Evidencias Originais",
                    "1ª Validação SCGE"
                ].join(';');

                const rows = avaliacaoCompleta.respostas.map(resposta => {
                    const req = resposta.requisito || {};
                    
                    const requisito = req.texto || '';                  
                    const pontuacao = req.pontuacao || 0;
                    const respostaOriginal = resposta.atendeOriginal === true ? 'Atende' : 
                            resposta.atendeOriginal === false ? 'Não Atende' : 'N/A';
                    
                    const comentarioOriginal = resposta.comentarioSecretaria || '';
                    
                    const evidenciasOriginais = Array.isArray(resposta.evidencias) ? 
                        resposta.evidencias
                            .filter(e => e.tipo === 'original')
                            .map(e => e.url)
                            .join(' | ') : '';
                    
                    let analiseSCGE = '';
                    if (resposta.statusValidacao === 'aprovado') {
                        analiseSCGE = 'Atende';
                    } else if (resposta.statusValidacao === 'rejeitado') {
                        analiseSCGE = 'Não Atende';
                    } else {
                        analiseSCGE = 'Pendente';
                    }

                    const escapeCSV = (field) => {
                        const str = String(field === null || field === undefined ? '' : field);
                        const sanitized = str.replace(/;/g, ',');
                        if (sanitized.includes('"') || sanitized.includes('\n') || sanitized.includes('\r') || sanitized.includes(',')) {
                            return `"${sanitized.replace(/"/g, '""')}"`;
                        }
                        return sanitized;
                    };

                    return [
                        escapeCSV(requisito),
                        escapeCSV(pontuacao),
                        escapeCSV(respostaOriginal),
                        escapeCSV(comentarioOriginal),
                        escapeCSV(evidenciasOriginais),
                        escapeCSV(analiseSCGE)
                    ].join(';');
                });

                const csvContent = [headers, ...rows].join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });

                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const nomeArquivo = `relatorio_recurso_${avaliacaoCompleta.secretaria?.sigla || avaliacaoId}_${new Date().toISOString().slice(0,10)}.csv`;
                    link.setAttribute("href", url);
                    link.setAttribute("download", nomeArquivo);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    console.log("Download CSV para recurso iniciado.");
                    
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'CSV baixado com sucesso!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } else {
                    Swal.fire('Erro', 'Seu navegador não suporta a funcionalidade de download direto.', 'error');
                }
            }

            function renderizarCardsDeResposta() {
                if (!avaliacaoCompleta || !Array.isArray(avaliacaoCompleta.respostas)) {
                    respostasContainer.innerHTML = '<p>Nenhuma resposta encontrada.</p>';
                    return;
                }

                const isRecursoPhase = avaliacaoCompleta.status === 'AGUARDANDO_RECURSO';
                const isBloqueado = avaliacaoCompleta.status === 'EM_ANALISE_SCGE' || avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO';

                if (avaliacaoCompleta.status !== 'FINALIZADA' && avaliacaoCompleta.status !== 'AGUARDANDO_RECURSO') {
                    document.getElementById('score-wrapper').style.display = 'none';
                } else {
                    document.getElementById('score-wrapper').style.display = 'block';
                }

                if (isRecursoPhase && prazoExpirado) {
                    respostasContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: #dc3545;">Prazo Expirado</h3>
                            <p>O prazo para envio de recursos expirou. Não é mais possível modificar as respostas.</p>
                            <p style="font-size: 0.9em; color: #6c757d;">Entre em contato com a Controladoria Geral do Estado para mais informações.</p>
                        </div>
                    `;
                    return;
                }

                if (isRecursoPhase && avaliacaoCompleta.respostas.some(r => r.recursoEnviado)) {
                    const requisitosComRecurso = avaliacaoCompleta.respostas.filter(r => r.recursoEnviado).length;
                    respostasContainer.innerHTML = `
                        <div class="recurso-info-card" style="margin-bottom: 25px;">
                            <h4>Recurso Enviado para Análise</h4>
                            <p>Seu recurso foi enviado com sucesso e está em análise pela Controladoria Geral do Estado.</p>
                            <p><strong>Requisitos com recurso:</strong> ${requisitosComRecurso} de ${avaliacaoCompleta.respostas.length}</p>
                            <p style="font-size: 0.9em; color: #6c757d; margin-top: 10px;">
                                O prazo estimado para análise é de 10 dias úteis.
                            </p>
                        </div>
                    `;
                }

                respostasContainer.innerHTML = avaliacaoCompleta.respostas.map(resposta => {
                    let cardClass = '';
                    let statusTexto = '';
                    let statusClass = '';
                    let showRecurso = false;
                    let recursoEnviado = resposta.recursoEnviado;

                    if (resposta.recursoEnviado) {
                        cardClass = 'card-com-recurso';
                        statusTexto = 'RECURSO ENVIADO';
                        statusClass = 'summary-status-recurso';
                    }
                    else if (avaliacaoCompleta.status === 'PENDENTE_SECRETARIA' || avaliacaoCompleta.status === 'EM_ANALISE_SCGE') {
                        statusTexto = 'PENDENTE';
                        statusClass = 'summary-status-pendente';
                        
                        const atende = resposta.atende;
                        cardClass = atende ? 'card-mantido-sim' : 'card-mantido-nao';
                    } 
                    else if (isRecursoPhase) {
                        if (recursoEnviado) {
                            const atendeFinal = resposta.atende;
                            
                            if (atendeFinal) {
                                cardClass = 'card-mantido-sim';
                                statusTexto = 'ATENDE';
                                statusClass = 'summary-status-atende';
                            } else {
                                cardClass = 'card-mantido-nao'; 
                                statusTexto = 'NÃO ATENDE';
                                statusClass = 'summary-status-nao-atende';
                            }
                            
                            cardClass += ' tem-recurso-enviado';
                        } else {
                            const isDivergent = resposta.atende !== (resposta.statusValidacao === 'aprovado');

                            if (isDivergent) {
                                if (resposta.atende) {
                                    cardClass = 'card-alterado-rejeitado';
                                    statusTexto = 'NÃO ATENDE';
                                    statusClass = 'summary-status-nao-atende';
                                    showRecurso = true;
                                } else {
                                    cardClass = 'card-alterado-aprovado';
                                    statusTexto = 'ATENDE';
                                    statusClass = 'summary-status-atende';
                                    
                                    const usuarioMarcouNaoAtende = !resposta.atende;
                                    const scgeValidouComoAtende = resposta.statusValidacao === 'aprovado';

                                    if (usuarioMarcouNaoAtende && scgeValidouComoAtende && isRecursoPhase && !recursoEnviado) {
                                        showRecurso = false; 
                                    } else {
                                        showRecurso = false;
                                    }
                                }
                            } else {
                                cardClass = resposta.atende ? 'card-mantido-sim' : 'card-mantido-nao';
                                statusTexto = resposta.atende ? 'MANTIDO' : 'NÃO ATENDE';
                                statusClass = resposta.atende ? 'summary-status-mantido' : 'summary-status-nao-atende';
                            }
                        }
                    }
                    else if (avaliacaoCompleta.status === 'FINALIZADA') {
                        const atende = resposta.statusValidacao === 'aprovado';
                        cardClass = atende ? 'card-mantido-sim' : 'card-mantido-nao';
                        statusTexto = atende ? 'ATENDE' : 'NÃO ATENDE';
                        statusClass = atende ? 'summary-status-atende' : 'summary-status-nao-atende';
                    }

                    if (resposta.linksAnalista && resposta.linksAnalista.length > 0) {
                        cardClass += ' tem-links-analista';
                    }

                    let recursoHTML = '';

                    const usuarioMarcouNaoAtende = !resposta.atende;
                    const scgeValidouComoAtende = resposta.statusValidacao === 'aprovado';

                    const ehCasoCardVerde = usuarioMarcouNaoAtende && scgeValidouComoAtende && isRecursoPhase && !recursoEnviado;

                    if (showRecurso && isRecursoPhase && !recursoEnviado && !ehCasoCardVerde) {
                        const mensagem = resposta.atende ? 
                            'Sua resposta "Atende" foi avaliada como "Não atende" após validação. Se desejar, corrija e forneça novas evidências abaixo.' : 
                            'Sua resposta "Não atende" foi avaliada como "Atende" após validação. Se desejar, corrija e forneça novas evidências abaixo.';
                        
                        recursoHTML = `
                            <div class="recurso-box" data-is-editable="true">
                                <h4>Área de Recurso</h4>
                                <p>${mensagem}</p>
                                <div class="requisito-actions">
                                    <span>Sua nova resposta:</span>
                                    <button class="btn-toggle" data-action="sim-recurso" title="Ao clicar em atende você afirma que a secretaria atende ao requisito">Atende</button>
                                    <button class="btn-toggle active" data-action="nao-recurso" title="Ao clicar em não atende afirma que a secretaria não atende ao requisito">Não atende</button>
                                </div>
                                <div class="link-comprovante-wrapper">
                                    <div class="evidence-container">
                                        <ul class="evidence-list-recurso evidence-list"></ul>
                                        <div class="add-evidence-buttons">
                                            <button class="btn-add-evidence add-link-btn" title="Adicionar nova evidência para comprovar o atendimento ao requisito">+ Adicionar Link</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-container">
                                    <textarea class="recurso-comment" placeholder="Adicionar justificativa para o recurso (opcional)..."></textarea>
                                </div>
                            </div>`;
                    }

                    let alertaRecursoHTML = ''; 

                    if (usuarioMarcouNaoAtende && scgeValidouComoAtende && isRecursoPhase && !recursoEnviado) {
                        alertaRecursoHTML = `
                        <div class="recurso-alerta" style="background-color: #f0fff4; border: 2px solid #28a745; color: #2d5016;">
                            <i class="fas fa-exclamation-triangle"></i> Esse requisito foi alterado de "Não atende" para "Atende".
                        </div>`;
                    } 
                    else if (showRecurso && isRecursoPhase && !recursoEnviado) {
                        alertaRecursoHTML = `<div class="recurso-alerta">Este requisito foi alterado na análise. CLIQUE AQUI e veja a análise e comentários feito pela SCGE e, se desejar, envie um recurso.</div>`;
                    }

                    const cardContent = `
                        <div class="resposta-body">
                            ${recursoHTML}
                        </div>
                    `;

                    let cardExtraClass = '';
                    let headerExtraClass = '';
                    let cursorStyle = '';
                    
                    if (isBloqueado) {
                        cardExtraClass = 'card-bloqueado';
                        headerExtraClass = 'summary-header-bloqueado';
                        cursorStyle = 'style="cursor: default;"';
                    }

                    if ((showRecurso && isRecursoPhase && !recursoEnviado) || recursoEnviado || (usuarioMarcouNaoAtende && scgeValidouComoAtende && isRecursoPhase && !recursoEnviado)) {

                        let detalhesRecursoHTML = '';
                        
                        if (recursoEnviado) {
                            const respostaOriginal = resposta.atendeOriginal ? 'Atende' : 'Não atende';
                            const respostaRecurso = resposta.atende ? 'Atende' : 'Não atende';
                            
                            detalhesRecursoHTML = `
                                <div class="detalhes-recurso">
                                    <h5>📋 Detalhes do Recurso Enviado</h5>
                                    <div class="info-recurso">
                                        <div class="info-item">
                                            <strong>Resposta Original</strong>
                                            ${respostaOriginal}
                                        </div>
                                        <div class="info-item">
                                            <strong>Resposta no Recurso</strong>
                                            ${respostaRecurso}
                                        </div>
                                    </div>
                                    ${resposta.comentarioRecurso ? `
                                        <div class="info-item" style="grid-column: 1 / -1;">
                                            <strong>Seu Comentário</strong>
                                            "${resposta.comentarioRecurso}"
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="resposta-card ${cardClass} ${cardExtraClass}" data-resposta-id="${resposta.id}" ${cursorStyle}>
                                ${alertaRecursoHTML}
                                <div class="resposta-header ${headerExtraClass}">
                                    <div class="resposta-header-content">
                                        <strong>${resposta.requisito.texto}</strong>
                                        <span class="summary-status-badge ${statusClass}">${statusTexto}</span>
                                    </div>
                                </div>
                                ${detalhesRecursoHTML}
                                ${cardContent}
                            </div>`;
                    } else {
                        const respostaData = JSON.stringify(resposta).replace(/"/g, '&quot;');
                        return `
                            <div class="resposta-card ${cardClass} ${cardExtraClass}" data-resposta-id="${resposta.id}" data-resposta='${respostaData}' role="article" ${cursorStyle}>
                                <div class="summary-header ${headerExtraClass}" tabindex="0" role="button" aria-expanded="false">
                                    <div class="resposta-header-content">
                                        <strong>${resposta.requisito.texto}</strong>
                                        <span class="summary-status-badge ${statusClass}">${statusTexto}</span>
                                    </div>
                                </div>
                            </div>`;
                    }
                }).join('');

                setTimeout(() => {
                    inicializarBotoesRecursoAutomatico();
                    carregarRascunhoRecurso();
                }, 200);
            }

            function adicionarEventListeners() {
                console.log('=== ADICIONANDO EVENT LISTENERS ===');

                respostasContainer.addEventListener('click', (event) => {
                    const isBloqueado = avaliacaoCompleta.status === 'EM_ANALISE_SCGE' || avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO';
                    
                    const target = event.target;
                    
                    const summaryHeader = target.closest('.summary-header');
                    if (summaryHeader) {
                        const card = summaryHeader.closest('.resposta-card');
                        let resposta;
                        
                        if (card.dataset.resposta) {
                            resposta = JSON.parse(card.dataset.resposta.replace(/&quot;/g, '"'));
                        } 
                        else if (card.dataset.respostaId) {
                            const respostaId = parseInt(card.dataset.respostaId);
                            resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                        }
                        
                        if (resposta) {
                            abrirModal(resposta);
                            return; 
                        }
                    }

                    if (target.closest('.recurso-alerta')) {
                        const card = target.closest('.resposta-card');
                        const respostaId = parseInt(card.dataset.respostaId);
                        const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                        if (resposta) {
                            abrirModal(resposta);
                            return; 
                        }
                    }

                    if (isBloqueado) {
                        if (target.closest('.recurso-box') || 
                            target.closest('.btn-toggle') || 
                            target.closest('.btn-editar-decisao') ||
                            target.closest('.add-link-btn')) {
                            event.preventDefault();
                            event.stopPropagation();
                            
                            Swal.fire({
                                title: 'Avaliação em Análise',
                                text: 'Esta avaliação está sendo analisada pela Controladoria Geral do Estado. Não é possível fazer alterações no momento.',
                                icon: 'info',
                                confirmButtonColor: 'var(--azul-gov-principal)'
                            });
                            return;
                        }
                    }
                });

                modalBody.addEventListener('click', (event) => {
                    const target = event.target;
                    const isBloqueado = avaliacaoCompleta.status === 'EM_ANALISE_SCGE' || avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO';

                    if (target.classList.contains('btn-editar-decisao')) {
                        if (isBloqueado) {
                            Swal.fire({
                                title: 'Avaliação em Análise',
                                text: 'Esta avaliação está sendo analisada pela Controladoria Geral do Estado. Não é possível fazer alterações no momento.',
                                icon: 'info',
                                confirmButtonColor: 'var(--azul-gov-principal)'
                            });
                            return;
                        }

                        event.preventDefault();
                        event.stopPropagation();

                        const respostaId = parseInt(target.dataset.respostaId);
                        fecharModal();

                        setTimeout(() => {
                            const card = document.querySelector(`.resposta-card[data-resposta-id="${respostaId}"]`);
                            if (card) {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });

                                card.style.transition = 'all 0.5s ease';
                                card.style.boxShadow = '0 0 0 3px var(--amarelo-gov-detalhe)';
                                setTimeout(() => { card.style.boxShadow = ''; }, 2000);

                                let recursoBox = card.querySelector('.recurso-box');
                                let respostaBody = card.querySelector('.resposta-body');

                                if (!recursoBox) {
                                    const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);
                                    if (resposta) {
                                        if (!respostaBody) {
                                            respostaBody = document.createElement('div');
                                            respostaBody.className = 'resposta-body';
                                            card.appendChild(respostaBody);
                                        } else {
                                            if (!respostaBody.querySelector('.recurso-box')) {
                                                respostaBody.innerHTML = '';
                                            }
                                        }

                                        const isRecursoPhase = avaliacaoCompleta.status === 'AGUARDANDO_RECURSO';
                                        const recursoEnviado = resposta.recursoEnviado || false;
                                        const showRecurso = true;

                                        criarRecursoHTML(respostaBody, resposta, isRecursoPhase, showRecurso, recursoEnviado);
                                        recursoBox = respostaBody.querySelector('.recurso-box');

                                        if (recursoBox) {
                                            const rascunhoSalvo = localStorage.getItem(`rascunho_recurso_${avaliacaoId}`);
                                            const rascunhoGeral = rascunhoSalvo ? JSON.parse(rascunhoSalvo) : {};
                                            const dadosRascunho = rascunhoGeral[respostaId];

                                            aplicarEstadoRascunhoAoBox(recursoBox, dadosRascunho);
                                            adicionarListenersAoBox(recursoBox);
                                        }
                                    }
                                } else {
                                    recursoBox.style.display = 'block';
                                }

                                if (recursoBox) {
                                    setTimeout(() => {
                                        const primeiroCampo = recursoBox.querySelector('.btn-toggle, .recurso-comment');
                                        if (primeiroCampo) { primeiroCampo.focus(); }
                                        Swal.fire({
                                            toast: true,
                                            position: 'top-end',
                                            icon: 'success',
                                            title: 'Área de recurso aberta!',
                                            showConfirmButton: false,
                                            timer: 2000
                                        });
                                    }, 100);
                                }
                            } else {
                                console.error(`Card para resposta ${respostaId} não encontrado após fechar modal.`);
                            }
                        }, 300);
                    }
                });

                modalCloseBtn.addEventListener('click', fecharModal);
                modalOverlay.addEventListener('click', (event) => {
                    if (event.target === modalOverlay) { 
                        fecharModal(); 
                    }
                });
                
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && modalOverlay.style.display === 'flex') {
                        fecharModal();
                    }
                });
            }

            // NOVA FUNÇÃO PARA CALCULAR E SALVAR NOTA PÓS-RECURSO 
            async function calcularESalvarNotaPosRecurso(avaliacaoId, respostasDoRecurso) {
                try {
                    console.log('🧮 Calculando nota pós-recurso...');
                    
                    const response = await fetch(`/api/my-avaliacoes/${avaliacaoId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Não foi possível buscar dados da avaliação');
                    }
                    
                    const avaliacaoAtualizada = await response.json();
                    let pontuacaoPosRecurso = 0;
                    let pontuacaoTotal = 0;

                    avaliacaoAtualizada.respostas.forEach(resposta => {
                        const pontuacaoRequisito = resposta.requisito?.pontuacao || 0;
                        pontuacaoTotal += pontuacaoRequisito;

                        let pontuacaoRequisitoPosRecurso = 0;
                        const teveRecurso = resposta.recursoAtende !== null || 
                                        resposta.comentarioRecurso ||
                                        (Array.isArray(resposta.evidencias) && resposta.evidencias.some(e => e.tipo === 'recurso'));

                        console.log(`Requisito ${resposta.requisitoId}:`);
                        console.log(`   - Pontuação: ${pontuacaoRequisito}`);
                        console.log(`   - Teve recurso: ${teveRecurso}`);
                        console.log(`   - recursoAtende: ${resposta.recursoAtende}`);

                        if (teveRecurso) {
                            if (resposta.recursoAtende === true) {
                                pontuacaoRequisitoPosRecurso = pontuacaoRequisito;
                                console.log(`   ✅ Adiciona ${pontuacaoRequisito} (recurso = true)`);
                            } else {
                                console.log(`   ❌ Não adiciona (recurso = false)`);
                            }
                        } else {
                            if (resposta.statusValidacao === 'aprovado') {
                                pontuacaoRequisitoPosRecurso = pontuacaoRequisito;
                                console.log(`   ✅ Adiciona ${pontuacaoRequisito} (sem recurso, aprovado)`);
                            } else {
                                console.log(`   ❌ Não adiciona (sem recurso, não aprovado)`);
                            }
                        }
                        
                        pontuacaoPosRecurso += pontuacaoRequisitoPosRecurso;
                    });

                    const notaCalculada = Math.round(pontuacaoPosRecurso);
                    console.log(`🎯 Nota pós-recurso calculada: ${notaCalculada}/${pontuacaoTotal}`);

                    const saveResponse = await fetch(`/api/avaliacoes/${avaliacaoId}/nota-pos-recurso`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ pontuacaoPosRecurso: notaCalculada })
                    });

                    if (!saveResponse.ok) {
                        const errorData = await saveResponse.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Falha ao salvar nota');
                    }

                    const result = await saveResponse.json();
                    console.log(`✅ Nota pós-recurso salva no banco: ${result.pontuacaoPosRecurso}`);
                    return result;

                } catch (error) {
                    console.error('❌ Erro ao salvar nota pós-recurso:', error);
                    return { success: false, error: error.message };
                }
            }

            async function enviarRecurso() {
                if (prazoExpirado) {
                    Swal.fire({
                        title: 'Prazo Expirado',
                        text: 'O prazo para envio de recurso já expirou.',
                        icon: 'warning',
                        confirmButtonColor: 'var(--azul-gov-principal)'
                    });
                    return;
                }
                
                console.log('=== INICIANDO ENVIO DE RECURSO CORRIGIDO ===');
                salvarRascunhoRecurso();
                
                const respostasDoRecurso = [];
                let formValido = true;

                for (const card of document.querySelectorAll('.recurso-box[data-is-editable="true"]')) {
                    const respostaCard = card.closest('.resposta-card');
                    const respostaId = parseInt(respostaCard.dataset.respostaId);
                    const resposta = avaliacaoCompleta.respostas.find(r => r.id === respostaId);

                    console.log(`Processando resposta ${respostaId}`);
                    console.log('Resposta original:', resposta);

                    const recursoAtende = card.querySelector('[data-action="sim-recurso"]')?.classList.contains('active') || false;
                    
                    let respostaPayload = { 
                        respostaId: respostaId,
                        comentarioRecurso: card.querySelector('.recurso-comment')?.value.trim() || '',
                        recursoAtende: recursoAtende, 
                        atende: recursoAtende 
                    };

                    const evidencias = [];
                    card.querySelectorAll('.evidence-item').forEach(item => {
                        if (item.dataset.link) {
                            evidencias.push({ 
                                tipo: 'recurso', 
                                url: item.dataset.link 
                            });
                        }
                    });
                    respostaPayload.evidencias = evidencias;

                    console.log(`Recurso enviado - Original: ${resposta.atendeOriginal}, Recurso: ${recursoAtende}`);

                    if (recursoAtende && evidencias.length === 0) {
                        Swal.fire({ 
                            icon: 'warning', 
                            title: 'Evidência Faltando', 
                            text: `O requisito "${respostaCard.querySelector('strong').textContent}" foi marcado como 'Atende' no recurso, mas nenhuma evidência foi adicionada.` 
                        });
                        formValido = false;
                        break;
                    }
                    
                    respostasDoRecurso.push(respostaPayload);
                }

                if (!formValido) return;

                console.log('Dados do recurso preparados (CORRIGIDOS):', respostasDoRecurso);

                if (respostasDoRecurso.length === 0) {
                    Swal.fire({
                        title: 'Confirmar Envio do Recurso?',
                        html: `
                            <div style="text-align: left;">
                                <p><strong>Você está prestes a enviar um recurso confirmando que concorda com todas as análises da SCGE.</strong></p>
                                <p>Esta ação confirmará que você aceita todos os resultados da validação sem fazer alterações.</p>
                                <p style="margin-top: 15px; color: #28a745; font-weight: bold;">
                                    ✅ Todos os requisitos serão mantidos conforme a análise da Controladoria.
                                </p>
                            </div>
                        `,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, Confirmar!',
                        cancelButtonText: 'Cancelar',
                        cancelButtonColor: 'var(--vermelho-erro)',
                        confirmButtonColor: 'var(--azul-gov-principal)',
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            // Enviar recurso vazio para confirmar aceitação
                            try {
                                const response = await fetch(`/api/avaliacoes/${avaliacaoId}/recurso`, {
                                    method: 'POST',
                                    headers: { 
                                        'Content-Type': 'application/json', 
                                        'Authorization': `Bearer ${authToken}` 
                                    },
                                    body: JSON.stringify({ 
                                        respostas: [], 
                                        avaliacaoId: avaliacaoId,
                                        confirmacaoTotal: true 
                                    })
                                });

                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    throw new Error(errorData.error || "Falha ao enviar confirmação.");
                                }

                                console.log('🔄 Confirmando nota atual como pós-recurso...');
                                const notaResult = await calcularESalvarNotaPosRecurso(avaliacaoId, []);
                                
                                if (notaResult.success) {
                                    console.log('🎉 Nota pós-recurso confirmada com sucesso');
                                }

                                try {
                                    await fetch(`/api/avaliacoes/${avaliacaoId}/notificar-recurso`, {
                                        method: 'POST',
                                        headers: { 
                                            'Content-Type': 'application/json', 
                                            'Authorization': `Bearer ${authToken}` 
                                        }
                                    });
                                    console.log('Controladoria notificada sobre a confirmação');
                                } catch (emailError) {
                                    console.warn('Confirmação enviada, mas notificação por email falhou');
                                }

                                await Swal.fire({
                                    title: 'Confirmação Enviada!',
                                    html: `
                                        <p>Você confirmou que concorda com todas as análises da SCGE.</p>
                                        <p><strong>Status:</strong> Avaliação em análise final</p>
                                    `,
                                    icon: 'success',
                                    confirmButtonColor: 'var(--azul-gov-principal)'
                                });
                                
                                localStorage.removeItem(`rascunho_recurso_${avaliacaoId}`);
                                window.location.href = '/dashboard';
                                
                            } catch (error) {
                                console.error('Erro ao enviar confirmação:', error);
                                Swal.fire({
                                    title: 'Erro!', 
                                    text: error.message, 
                                    icon: 'error',
                                    confirmButtonColor: 'var(--vermelho-erro)'
                                });
                            }
                        }
                    });
                    return;
                }

                Swal.fire({
                    title: 'Confirmar Envio do Recurso?',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Você está prestes a enviar recurso para ${respostasDoRecurso.length} requisito(s):</strong></p>
                            <ul style="text-align: left; margin-left: 20px;">
                                ${respostasDoRecurso.map(r => {
                                    const resposta = avaliacaoCompleta.respostas.find(resp => resp.id === r.respostaId);
                                    return `<li>${resposta?.requisito.texto || 'Requisito'}</li>`;
                                }).join('')}
                            </ul>
                            <p style="margin-top: 15px; color: #dc3545; font-weight:">
                                ⚠️ Após o envio, não será possível editar o recurso.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    iconColor: 'var(--amarelo-gov-detalhe)',
                    showCancelButton: true,
                    confirmButtonText: 'Sim, Enviar!',
                    cancelButtonText: 'Cancelar',
                    cancelButtonColor: 'var(--vermelho-erro)',
                    confirmButtonColor: 'var(--azul-gov-principal)',
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/api/avaliacoes/${avaliacaoId}/recurso`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json', 
                                    'Authorization': `Bearer ${authToken}` 
                                },
                                body: JSON.stringify({ 
                                    respostas: respostasDoRecurso,
                                    avaliacaoId: avaliacaoId
                                })
                            });

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.error || "Falha ao enviar recurso.");
                            }

                            console.log('🔄 Iniciando cálculo da nota pós-recurso...');
                            const notaResult = await calcularESalvarNotaPosRecurso(avaliacaoId, respostasDoRecurso);
                            
                            if (notaResult.success) {
                                console.log('🎉 Nota pós-recurso salva com sucesso durante envio do recurso');
                            } else {
                                console.warn('⚠️ Nota pós-recurso não foi salva, mas recurso foi enviado');
                            }

                            try {
                                const notificacaoResponse = await fetch(`/api/avaliacoes/${avaliacaoId}/notificar-recurso`, {
                                    method: 'POST',
                                    headers: { 
                                        'Content-Type': 'application/json', 
                                        'Authorization': `Bearer ${authToken}` 
                                    }
                                });

                                if (!notificacaoResponse.ok) {
                                    console.warn('Recurso enviado, mas notificação por email falhou');
                                } else {
                                    console.log('Controladoria notificada sobre o recurso');
                                }
                            } catch (emailError) {
                                console.warn('Erro na notificação por email:', emailError);
                            }

                            const resultData = await response.json();
                            console.log('Recurso enviado com sucesso:', resultData);
                            
                            await Swal.fire({
                                title: 'Recurso Enviado!',
                                html: `
                                    <p>A SCGE foi notificada e em breve você terá a análise do recurso.</p>
                                    <p><strong>Requisitos com recurso:</strong> ${respostasDoRecurso.length}</p>
                                `,
                                icon: 'success',
                                confirmButtonColor: 'var(--azul-gov-principal)'
                            });
                            
                            localStorage.removeItem(`rascunho_recurso_${avaliacaoId}`);
                            window.location.href = '/dashboard';
                            
                        } catch (error) {
                            console.error('Erro ao enviar recurso:', error);
                            Swal.fire({
                                title: 'Erro!', 
                                text: error.message, 
                                icon: 'error',
                                confirmButtonColor: 'var(--vermelho-erro)'
                            });
                        }
                    }
                });
            }

            function iniciarVerificacaoPeriodica() {
                if (avaliacaoCompleta.status === 'AGUARDANDO_RECURSO') {
                    console.log('Iniciando verificação periódica do prazo...');
                    
                    const intervalo = setInterval(async () => {
                        if (prazoInfo && prazoInfo.dentroDoPrazo && !prazoExpirado) {
                            prazoInfo.segundosRestantes = Math.max(0, prazoInfo.segundosRestantes - 1);
                            const segundos = prazoInfo.segundosRestantes;

                            if (segundos <= 0) {
                                prazoExpirado = true; 
                                clearInterval(intervalo); 
                                console.log('Prazo expirou! Recarregando página...');
                                Swal.fire({
                                    title: 'Prazo Expirado!',
                                    text: 'O prazo para recurso expirou. A página será atualizada.',
                                    icon: 'warning',
                                    confirmButtonColor: 'var(--azul-gov-principal)',
                                    allowOutsideClick: false
                                }).then(() => {
                                    location.reload();
                                });
                            }

                            else if (segundos <= 60 && !warned1min) {
                                warned1min = true;
                                warned5min = true; 
                                warned10min = true;
                                Swal.fire({
                                    toast: true, position: 'top-end', icon: 'error',
                                    title: 'ALERTA DE PRAZO!',
                                    text: 'Resta apenas 1 minuto para enviar o recurso.',
                                    showConfirmButton: false, timer: 5000, timerProgressBar: true
                                });
                            }
                            else if (segundos <= 300 && !warned5min) {
                                warned5min = true;
                                warned10min = true; 
                                Swal.fire({
                                    toast: true, position: 'top-end', icon: 'warning',
                                    title: 'Aviso de Prazo',
                                    text: 'Restam apenas 5 minutos para enviar o recurso.',
                                    showConfirmButton: false, timer: 5000, timerProgressBar: true
                                });
                            }
                            else if (segundos <= 600 && !warned10min) {
                                warned10min = true;
                                Swal.fire({
                                    toast: true, position: 'top-end', icon: 'info',
                                    title: 'Aviso de Prazo',
                                    text: 'Restam 10 minutos para enviar o recurso.',
                                    showConfirmButton: false, timer: 5000, timerProgressBar: true
                                });
                            }

                            exibirInformacoesPrazo();
                            
                            if (segundos % 10 === 0) {
                                console.log('Sincronizando prazo com o servidor...');
                                await verificarPrazoRecurso();
                                if (prazoInfo.recursoExpirado || !prazoInfo.dentroDoPrazo) {
                                    console.log('Servidor confirmou expiração do prazo.');
                                    prazoExpirado = true;
                                }
                            }
                        } else if (prazoExpirado) {
                            clearInterval(intervalo);
                        }
                    }, 1000); 
                }
            }

            try {
                console.log('=== CARREGANDO DADOS DA AVALIAÇÃO ===');
                const response = await fetch(`/api/my-avaliacoes/${avaliacaoId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Não foi possível carregar os dados desta avaliação.');
                avaliacaoCompleta = await response.json();
                
                await verificarPrazoRecurso();
                exibirInformacoesPrazo();

                console.log('Dados da avaliação carregados:', avaliacaoCompleta);
                console.log('Prazo expirado?', prazoExpirado);

                if (!avaliacaoCompleta.respostas || !Array.isArray(avaliacaoCompleta.respostas)) { 
                    avaliacaoCompleta.respostas = []; 
                }

                const dataFormatada = new Date(avaliacaoCompleta.createdAt).toLocaleString('pt-BR');                
                summaryContainer.innerHTML = `
                    <h1>Detalhes da Autoavaliação</h1>
                    <div class="report-summary">
                        <span><strong>Órgão:</strong> ${avaliacaoCompleta.secretaria.nome}</span>
                        <span><strong>Enviado por:</strong> ${avaliacaoCompleta.nomeResponsavel || 'Não informado'}</span>
                        <span><strong>Ciclo:</strong> ${avaliacaoCompleta.ciclo}</span>
                        <span><strong>Enviado em:</strong> ${dataFormatada}</span>
                    </div>
                `;

                const pontuacoes = calcularPontuacaoRecurso();
                scoreSecretariaEl.textContent = `${pontuacoes.pontuacaoSecretaria} / ${pontuacoes.pontuacaoTotal}`;
                scoreAdminEl.textContent = `${pontuacoes.pontuacaoAdmin} / ${pontuacoes.pontuacaoTotal}`;

                renderizarCardsDeResposta();
                adicionarEventListeners();

                if(avaliacaoCompleta.status === 'AGUARDANDO_RECURSO' && !prazoExpirado) {
                    recursoActionsContainer.innerHTML = `
                        <div style="display: flex; gap: 15px; justify-content: flex-end; align-items: center; flex-wrap: wrap;">
                            <button id="csv-recurso-btn" class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                Baixar CSV para Análise
                            </button>
                            <button id="enviar-recurso-btn" class="btn">Confirmar ou Enviar Recurso</button>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #666;">
                            <p>💡 <strong>Dica:</strong> Se você concorda com todas as análises da SCGE, clique no botão para confirmar.</p>
                        </div>
                    `;
                    
                    document.getElementById('enviar-recurso-btn').addEventListener('click', enviarRecurso);
                    document.getElementById('csv-recurso-btn').addEventListener('click', gerarCSVRecurso);

                } else if (avaliacaoCompleta.status === 'AGUARDANDO_RECURSO' && prazoExpirado) {
                    recursoActionsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-top: 20px;">
                            <h4 style="color: #dc3545; margin-bottom: 10px;">Prazo Expirado</h4>
                            <p style="color: #6c757d; margin-bottom: 15px;">O prazo para envio de recursos expirou.</p>
                            <p style="font-size: 0.9em; color: #495057;">
                                <strong>Status:</strong> Aguardando análise final da SCGE
                            </p>
                        </div>
                    `;
                } else if (avaliacaoCompleta.status === 'EM_ANALISE_DE_RECURSO') {
                    recursoActionsContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-top: 20px;">
                            <h4 style="color: #6f42c1; margin-bottom: 10px;">Recurso Enviado</h4>
                            <p style="color: #6c757d; margin-bottom: 15px;">Seu recurso está em análise pela Controladoria Geral do Estado.</p>
                            <p style="font-size: 0.9em; color: #495057;">
                                <strong>Status:</strong> Em análise de recurso
                            </p>
                        </div>
                    `;
                }
                
                iniciarVerificacaoPeriodica();

            } catch (error) {
                console.error("Erro detalhado:", error);
                summaryContainer.innerHTML = `<h1>Erro ao Carregar Relatório</h1><p>${error.message}</p>`;
            }
        });
    </script>
    <script src="/global.js"></script>
</body>
</html>